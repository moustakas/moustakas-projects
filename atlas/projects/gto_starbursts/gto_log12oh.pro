; COMPARE THE MARTIN 1997 ABUNDANCES OF MATCHING OBJECTS: NGC1569,
; NGC4449, 

; SBS0335-052W - compare and average Izotov et 2005
;                and Papaderos et 2006; [note that the Lipovetsky et
;                1999 value is crappy because of a problem with their
;                4363 measurement -- see Izotov et 2005]

; IZW18 - average the NW and SE components; also note that for the SE
;         component Skillman & Kennicutt 1993 and Izotov et 1997,1999
;         get fairly different answers; however, keep both of them,
;         since there may be somewhat large spatial Te variations [see 
;         discussion in Izotov et 1999]

; UGCA292 - average the two van Zee papers

; SBS0335-052E - average the Papaderos and Izotov papers

; SHOC567 - no [OII] 3727 from the Kniazev et al. 2004 catalog, but
;           [OII] 7320,7330 can be used; so just adopt the Kniazev et
;           al. value (see the paper for more details)

; HS0822+3542 - need to cross-check the Kniazev, Izotov, Guseva, and
;               Pustilnick et al. (2003) numbers and then average
;               appropriately; it looks like the abundance is around
;               7.45 (Kniazev et al. 2003), which means that the
;               Kniazev et al. 2000 number (7.35) is crap; note that
;               Kniazev et al. 2003 do not give the data, just the
;               result! 

; UGC04483 - compare and average Skillman et 1994 and van Zee & Haynes
;            2006 

; ESO489-G56 - one value from Ronnback & Bergvall 1995

; KUG1013+381 = HS1013+3809 - no data given in Kniazev & Pustilnik
;                             1998, so just use their value,
;                             12+log(O/H)=7.58; assume an error

; TOL1214-277 - average Izotov et al. 2001,2004 and Fricke et
;               al. 2001, if they agree

; TOL65 - average Izotov et al. 2001,2004

; TOL0618-402 - average Masegosa et al. 1994

; TOL2138-405 - one value from Guseva et al. 2007

; SBS1102+606 - no data given in Kniazev et al. 2003, so just use
;               their value 7.64+/-0.04

; VIIZw403=UGC06456 - comparing with Izotov et reveals that the Lee
;                     values are mostly crap, so don't use them; also
;                     note that the Lynds et al. 1998 values are from
;                     the Izotov paper
    
; UM461 - cross-check and average Guseva et 2007; Izotov et 1998,2006; 
;         Kniazev et 2004

; MRK178 - cross-check and average Guseva et 2000; Izotov et 2006

; Haro 11 - one value from Bergvall & Oestlin 2000

; UM420 - one value from Izotov & Thuan 1998

; UGC04393 - one value from Kniazev et 2004

; POX4a,b - probably use Guseva et 2007, but check Campbell et 1986
;           (do not use Kunth & Joubert 1985); also check Vacca et
;           1992

; MRK1450 - check and then average Izotov et 1994 and Guseva et 00

; MRK1094 - check and compare Shi et 2005; Mendez et 1999; Vacca et
;           1992 

; UM462=UGC06850 - Izotov et 1998,2006; Guseva et 2000,2007; Kniazev
;                  et 2004; Campbell et 1986; and lots more; compare
;                  and average

; TOL2 - compare and average Masegosa et 1994; Vacca et 1992; Kunth &
;        Joubert 1985

; NGC4861 - Izotov et 1997 and (possibly) Guseva et 2000

; MRK206 - one value from Kniazev et 2004

; SHOC391 - compare and average Kniazev et 2004; Guseva et 2007;
;           Izotov et 2006 (note the larger errors on Kniazev and
;           Izotov because they don't have 3727)

; MRK153 - one value from Izotov et 2006

; Minkowski's Object - the Croft et al. 2006 data should far
;                      supersede van Breugel et al. 1985, but make
;                      sure; no Te possible     

; IIZw40 - lots of data here, some better than the other;
;          check/compare and average

; MRK162 - compare and average Izotov & Thuan 1998 and Guseva et 2000 

; MRK930 - compare and average Izotov & Thuan 1998 and Guseva et 2000 

; NGC5253 - compare and average Lopez-Sanchez et 2007; Kobulnicky et
;           1997; definitely toss out Webster & Smith 1983 and
;           Campbell et 1986

; NGC1156 - use MK06: note that the following papers all cite Talent
;           (1980) but get different metallicities!: 8.30 (Matteucci &
;           Chiosi 1983); 8.29+/-0.2 (Hunter & Hoffman 1999); 8.23
;           (Vigroux et 1987); 8.23 (Lisenfeld & Ferrera 1998)!!
    
; NGC1569 - average the values from Kobulnicky & Skillman 1997

; Mrk170 - one value from Izotov et 2006    
    
; NGC3125 - good values by Hadfield & Crowther 2006; measurements also
;           made by Vacca et 1992, but I would consider them less
;           reliable (see discussion in Section 3.1 of Hadfield &
;           Crowther)

; NGC4214 - average Kobulnicky & Skillman 1996; [additional data in
;           Masegosa et 1991, if necessary]

; NGC4449 - another crappy situation; Skillman et 1989 quote 8.32 as
;           the metallicity, but that was taken from Talent (1980);
;           Boker recently observed the central star cluster, but
;           their Te abundance gives 7.8+/-0.3; McCall et 1985
;           observed three HII regions, and I might average the
;           strong-line abundances for those; or I can use the Martin
;           1997 Te metallicity, 8.31+/-0.07 (but not data given)

; NGC4670 - use MK06; [Heckman et 1998 give 8.2, but no data; also
;           some measurements in Mas-Hesse & Kunth 1999, but not
;           great] 
    
; NGC1140=Mrk1063 - one value from Izotov & Thuan 2004

; UM448 - compare and average Izotov et 1998,2006 and Kniazev et 2004 

; He2-10 - use Kobulnicky et 1999, and do not use the substantially
;          older D'Odorico et 1983; Vacca et 1992 data; see
;          discussion in Martin-Hernandez et 2006 for a more detailed
;          discussion; this metallicity is quite uncertain!!

; NGC1510 - the value from Storchi-Bergmann et 1994,1995 is crap (the
;           abundance on the upper branch, 8.0, is significantly lower
;           than the abundance on the lower branch, 8.6); so use the
;           fluxes from Raimann et 2000

; NGC3310 - compare and average Pastoriza et 1993

; UGC04703=Zw0855+06 - good measurement in Shi et 2005/Kong et 2002;
;                      could also check Kunth & Joubert 1985 Te value 

; NGC2537=Mrk86 - could use Gil de Paz et 2000 (but a pain in the ass
;                 to type in!), just use MK06

; NGC7714 - compare and average Gonzalez-Delgado et 1995 [useful
;           follow-up reference is Garcia-Vargas et 1997]; note that
;           what we want here is the nuclear metallicity, which is
;           around 8.5, rather than the HII-region metallicity, 8.2
;           [maybe!] 

; NGC3079 - use MK06

; NGC2782 - use MK06

; NGC3077 - use MK06

; NGC5236=M83 - abundance gradient using many references

; NGC3367 - use MK06

; NGC3628 - use MK06

; NGC4194=Mrk201 - Shi et 2005/Kong et 2002; also: unpublished data in
;                  Hancock et 2006 [Weinstrop et, in prep], who get
;                  8.1-8.9 in multiple HII regions; Storchi-Bergmann
;                  et 1994 get 8.81

; NGC5953 - Gonzalez-Delgado et 1996 detected 4363 in the nucleus;
;           probably use MK06

; NGC2146 - use MK06

; MRK0025 - use Kong & Cheng 1999; Zamorano & Rego 1986 is crap,
;           so don't use; also note that Kunth & Joubert 1985
;           got a metallicity of 8.6, but the data aren't great
;           [uncertain 4363 detection, non-linear detector]

; NGC1614 - use MK06 [some data in Vacca et 1992, but no 4363
;           detection] 

; NGC2903 - abundance gradient using many references

; MRK331 - use MK06

; NGC3256 - some data in Storchi-Bergmann et 1994, but pretty crappy;
;           one measurement in Lipari et 2000; compare and average 72

; IC342 - abundance gradient using McCall et 1985 HII regions

pro gto_log12oh, gto, hii, allatlas, allatlas_nodust, result, $
  weighted_avg=weighted_avg, silent=silent, write=write

    weighted_avg = 0L ; NOTE!!!
    silent = 1L
    
    outpath = gto_path()
    version = gto_log12oh_version()
    
    snrcut_log12oh = 5.0

    if (n_elements(gto) eq 0L) then gto = gto_read_ancillary()
    if (n_elements(hii) eq 0L) then hii = mrdfits(outpath+'gto_hiiregions_'+version+'.fits.gz',1,/silent)
    if (n_elements(allatlas) eq 0L) then allatlas = read_gto_atlas_sample(datanodust=allatlas_nodust)

    ngalaxy = n_elements(gto)
    nhii = n_elements(hii)

    nmonte = 500L
    rr25axis = findgen(51)/10.0
    rr25_char = 0.4
    nhii_min = 5L
    r25frac_min = 0.3 ; minimum HII-region disk covering fraction
    r23_cut = 1.1
    rc3_rr25_max = 1.0 ; 2.0
;   kk04_err = 0.1 ; NOTE!!

    oh_minerr = 0.1
    ohte_minerr = 0.05
    
    ohrange = [7.0,9.7]
    rr25range = [-0.1,1.2>rc3_rr25_max] ; [-0.1,1.6] ; [-0.2,1.9]

    hiigalaxy1 = {$
      number:                          0L, $
      galaxy:                          '', $
      ned_galaxy:                      '', $
      region:                          '', $
      raoffset:                    -999.0, $
      deoffset:                    -999.0, $
                          
      r23:                [-999.0,-999.0], $
      o32:                [-999.0,-999.0], $
      p:                  [-999.0,-999.0], $
      
      log12oh_kk04:       [-999.0,-999.0], $
      log12oh_pt05:       [-999.0,-999.0], $
      log12oh_o3n2:       [-999.0,-999.0], $
      log12oh_te:         [-999.0,-999.0], $ ; electron temperature
      log12oh_te_lit:     [-999.0,-999.0], $ ; literature electron temperature
      
      log12oh_pt05_upper: [-999.0,-999.0], $
      log12oh_kk04_upper: [-999.0,-999.0], $
      log12oh_pt05_lower: [-999.0,-999.0], $
      log12oh_kk04_lower: [-999.0,-999.0], $

      hii_kk04_r23_flag:               0L, $ ; lower branch solution greater than upper branch
      hii_pt05_r23_flag:               0L, $ ; lower branch solution greater than upper branch

      n2:                 [-999.0,-999.0], $
      n2o2:               [-999.0,-999.0], $
      r23_branch:                     '?', $
      rc3_radius:                  -999.0, $
      rc3_rr25:                    -999.0, $
      twomass_radius:              -999.0, $
      twomass_rr25:                -999.0, $
      texref:                          '', $
      reference:                       ''}
    
; initialize the output data structure    
    
    result = {$

      gto_id:                                  0L, $
      galaxy:                                  '', $
      atlas_galaxy:                            '', $
      ned_galaxy:                              '', $
      nice_galaxy:                             '', $
      ebv_mw:                              -999.0, $
      m_b:                                 -999.0, $
      m_b_err:                             -999.0, $
      distance:                            -999.0, $
      distance_err:                        -999.0, $
      distance_texref:                         '', $
      type:                                    '', $
      t:                                      0.0, $
      d25:                                 -999.0, $
      r25:                                 -999.0, $
      incl:                                -999.0, $
      pa:                                  -999.0, $
      gradient_flag:                           0L, $ ; abundance gradient? (0 or 1)
      class:                                'HII', $ ; final spectral class
      class_remarks:                           '', $

      chad_log12oh:                        -999.0, $
      chad_log12oh_err:                    -999.0, $
;     chad_log12oh_ref:                        '', $
      
      hii_nhii:                                0L, $ ; number of HII regions
      hii_r25frac:                            0.0, $ ; fraction of the R25 radius spanned by the HII regions

      hii_kk04_nhii_used:                      0L, $ ; number of HII regions used
      hii_kk04_slope:             [-999.0,-999.0], $ ; KK04 abundance gradient slope
      hii_kk04_slope_flag:                     0L, $ ; formal positive slope
      hii_kk04_log12oh_central:   [-999.0,-999.0], $ ; KK04 abundance gradient intercept
      hii_kk04_log12oh_char:      [-999.0,-999.0], $ ; characteristic KK04 metallicity (R=0.4R25)
      hii_kk04_log12oh_avg:       [-999.0,-999.0], $ ; average KK04 metallicity
      hii_kk04_rr25_avg:          [-999.0,-999.0], $ ; average RR25 position of the KK04 metallicity
      hii_kk04_texrefs:                        '', $ ; references

      hii_pt05_nhii_used:                      0L, $ ; number of HII regions used
      hii_pt05_slope:             [-999.0,-999.0], $ ; PT05 abundance gradient slope
      hii_pt05_slope_flag:                     0L, $ ; formal positive slope
      hii_pt05_log12oh_central:   [-999.0,-999.0], $ ; PT05 abundance gradient intercept
      hii_pt05_log12oh_char:      [-999.0,-999.0], $ ; characteristic PT05 metallicity (R=0.4R25)
      hii_pt05_log12oh_avg:       [-999.0,-999.0], $ ; average PT05 metallicity
      hii_pt05_p_avg:             [-999.0,-999.0], $ ; average excitation P-parameter
      hii_pt05_rr25_avg:          [-999.0,-999.0], $ ; average RR25 position of the PT05 metallicity
      hii_pt05_texrefs:                        '', $ ; references
                                  
      hii_o3n2_nhii_used:                      0L, $ ; number of HII regions used
      hii_o3n2_slope:             [-999.0,-999.0], $ ; O3N2 abundance gradient slope
      hii_o3n2_slope_flag:                     0L, $ ; formal positive slope
      hii_o3n2_log12oh_central:   [-999.0,-999.0], $ ; O3N2 abundance gradient intercept
      hii_o3n2_log12oh_char:      [-999.0,-999.0], $ ; characteristic O3N2 metallicity (R=0.4R25)
      hii_o3n2_log12oh_avg:       [-999.0,-999.0], $ ; average O3N2 metallicity
      hii_o3n2_rr25_avg:          [-999.0,-999.0], $ ; average RR25 position of the O3N2 metallicity
      hii_o3n2_texrefs:                        '', $ ; references
                                      
      hii_te_nhii_used:                        0L, $ ; number of HII regions used
      hii_te_log12oh_avg:         [-999.0,-999.0], $ ; average Te metallicity
      hii_te_texrefs:                          '', $ ; references
      
      r23_branch:                             '?', $
      
      atlas_hahb:             [-999.0,-999.0], $
      atlas_ebv:              [-999.0,-999.0], $
      atlas_ewhb:                      -999.0, $
      atlas_ewhb_abs:                  -999.0, $
      atlas_log12oh_kk04:     [-999.0,-999.0], $
      atlas_log12oh_pt05:     [-999.0,-999.0], $
      atlas_log12oh_o3n2:     [-999.0,-999.0], $
      atlas_r23:              [-999.0,-999.0], $
      atlas_o32:              [-999.0,-999.0], $
      atlas_p:                [-999.0,-999.0], $

      log12oh_final:                   -999.0, $
      log12oh_final_err:               -999.0, $
      log12oh_final_ref:                '...', $
      log12oh_final_comment:            '...'}
      
    result = replicate(result,ngalaxy)
    
    result.gto_id      = lindgen(ngalaxy)
    result.galaxy      = gto.galaxy
    result.ned_galaxy  = gto.ned_galaxy
    result.nice_galaxy = gto.nice_galaxy
    result.type        = strtrim(gto.lit_type,2)
    result.t           = gto.lit_t
    result.d25         = gto.d25_maj
    result.r25         = gto.d25_maj/2.0
    result.ebv_mw      = gto.ebv_mw
    result.m_b         = gto.rc3_m_b
    result.m_b_err     = gto.rc3_m_b_err

    result.incl = gto.inclination
    result.pa   = gto.posangle

    result.distance        = gto.distance
    result.distance_err    = gto.distance_err
    result.distance_texref = gto.distance_texref
    
    branchinfo = rsex(outpath+'gto_r23branch.sex')
    result.r23_branch = branchinfo.r23_branch

; read and store Chad's metallicities

    readcol, outpath+'ancillary/chad_metallicity.dat', chad_galaxy, chad_log12oh, $
      chad_log12oh_err, chad_log12oh_ref, format='A,F,F,A', /silent, comment='#'
    match, strlowcase(strtrim(result.galaxy,2)), strlowcase(strtrim(chad_galaxy,2)), aa, bb
;   niceprint, result[aa].galaxy, chad_galaxy[bb]
    result[aa].chad_log12oh     = chad_log12oh[bb]
    result[aa].chad_log12oh_err = chad_log12oh_err[bb]
;   result[aa].chad_log12oh_ref = chad_log12oh_ref[bb]

; apply S/N cuts

    atlas_keep = where($
      (allatlas.h_alpha[0]  /allatlas.h_alpha[1]   gt snrcut_log12oh) and $
      (allatlas.h_beta[0]   /allatlas.h_beta[1]    gt snrcut_log12oh) and $
;     (allatlas.nii_6584[0] /allatlas.nii_6584[1]  gt snrcut_log12oh) and $
      (allatlas.oii_3727[0] /allatlas.oii_3727[1]  gt snrcut_log12oh) and $
      (allatlas.oiii_5007[0]/allatlas.oiii_5007[1] gt snrcut_log12oh),$
      natlas_keep,comp=drop)
;    niceprint, allatlas[drop].galaxy, $
;      allatlas[drop].h_alpha[0]/allatlas[drop].h_alpha[1], $
;      allatlas[drop].h_beta[0]/allatlas[drop].h_beta[1], $
;;     allatlas[drop].nii_6584[0]/allatlas[drop].nii_6584[1], $
;      allatlas[drop].oii_3727[0] /allatlas[drop].oii_3727[1], $
;      allatlas[drop].oiii_5007[0]/allatlas[drop].oiii_5007[1]

    atlas = allatlas[atlas_keep]
    atlas_nodust = allatlas_nodust[atlas_keep]

    splog, 'GTO/ATLAS: '+string(natlas_keep,format='(I0)')+'/'+$
      string(n_elements(allatlas),format='(I0)')+$
      ' galaxies made the S/N cuts.'

; ---------------------------------------------------------------------------    
; loop on each object
; ---------------------------------------------------------------------------    

    galaxy = strtrim(result.galaxy,2)

    for k = 0, ngalaxy-1L do begin
;   for k = 31, ngalaxy-1L do begin

;      print, k, gto[k].galaxy
       
; ###########################################################################
; store the integrated quantities/abundances
; ###########################################################################

       match = where(strtrim(result[k].ned_galaxy,2) eq strtrim(atlas.ned_galaxy,2),nmatch)
       if (nmatch ne 0L) then begin

          result[k].atlas_galaxy   = atlas[match].galaxy
          result[k].atlas_ebv      = [atlas_nodust[match].ebv_hahb,atlas_nodust[match].ebv_hahb_err]
          result[k].atlas_r23      = [atlas_nodust[match].zstrong_r23,atlas_nodust[match].zstrong_r23_err]
          result[k].atlas_p        = [atlas_nodust[match].zstrong_p,atlas_nodust[match].zstrong_p_err]
          result[k].atlas_ewhb     = atlas[match].h_beta_ew[0]
          result[k].atlas_ewhb_abs = atlas[match].babs_h_beta_ew[0]

          if (result[k].r23_branch eq 'U') and (strtrim(result[k].class,2) ne 'AGN') then begin
             result[k].atlas_log12oh_pt05 = [atlas_nodust[match].zstrong_12oh_pt05_upper,atlas_nodust[match].zstrong_12oh_pt05_upper_err]
             result[k].atlas_log12oh_kk04 = [atlas_nodust[match].zstrong_12oh_kk04_r23_upper,atlas_nodust[match].zstrong_12oh_kk04_r23_upper_err]
          endif

          if (result[k].r23_branch eq 'L') and (strtrim(result[k].class,2) ne 'AGN')  then begin
             result[k].atlas_log12oh_pt05 = [atlas_nodust[match].zstrong_12oh_pt05_lower,atlas_nodust[match].zstrong_12oh_pt05_lower_err]
             result[k].atlas_log12oh_kk04 = [atlas_nodust[match].zstrong_12oh_kk04_r23_lower,atlas_nodust[match].zstrong_12oh_kk04_r23_lower_err]
          endif

          result[k].atlas_log12oh_o3n2 = [atlas[match].zstrong_12oh_oiiinii_niiha,atlas[match].zstrong_12oh_oiiinii_niiha_err]

; add a minimum uncertainty to the strong-line methods

          if (result[k].atlas_log12oh_pt05[1] gt -900.0) then result[k].atlas_log12oh_pt05[1] = $
            sqrt(result[k].atlas_log12oh_pt05[1]^2.0+oh_minerr^2)
          if (result[k].atlas_log12oh_kk04[1] gt -900.0) then result[k].atlas_log12oh_kk04[1] = $
            sqrt(result[k].atlas_log12oh_kk04[1]^2.0+oh_minerr^2)
          if (result[k].atlas_log12oh_o3n2[1] gt -900.0) then result[k].atlas_log12oh_o3n2[1] = $
            sqrt(result[k].atlas_log12oh_o3n2[1]^2.0+oh_minerr^2)
          
       endif

; ##################################################
; does this galaxy have any HII-region measurements?
; ##################################################

       indx = where(strtrim(strupcase(galaxy[k]),2) eq strtrim(strupcase(hii.hii_galaxy),2),nindx) ; SEE WRITE_GTO_HIIREGIONS
;      indx = where(strtrim(strupcase(result[k].ned_galaxy),2) eq strtrim(strupcase(hii.ned_galaxy),2),nindx)
       if (nindx ne 0L) then begin

          result[k].hii_nhii = nindx

; fill the HII-region structure for this galaxy

          hiigalaxy                = replicate(hiigalaxy1,nindx)
          hiigalaxy.number         = lindgen(nindx)+1L
          hiigalaxy.galaxy         = strtrim(hii[indx].hii_galaxy,2)
          hiigalaxy.ned_galaxy     = strtrim(hii[indx].ned_galaxy,2)
          hiigalaxy.region         = strtrim(hii[indx].hii_region,2)
          hiigalaxy.raoffset       = hii[indx].hii_raoffset
          hiigalaxy.deoffset       = hii[indx].hii_deoffset

          hiigalaxy.reference      = hii[indx].reference
          hiigalaxy.texref         = hii[indx].texref
          hiigalaxy.rc3_radius     = hii[indx].hii_rc3_radius
          hiigalaxy.rc3_rr25       = hii[indx].hii_rc3_rr25
          hiigalaxy.twomass_radius = hii[indx].hii_twomass_radius
          hiigalaxy.twomass_rr25   = hii[indx].hii_twomass_rr25

          hiigalaxy.n2   = transpose([ [hii[indx].zstrong_niiha], [hii[indx].zstrong_niiha_err] ])
          hiigalaxy.n2o2 = transpose([ [hii[indx].zstrong_niioii], [hii[indx].zstrong_niioii_err] ])

          hiigalaxy.r23 = transpose([ [hii[indx].zstrong_r23], [hii[indx].zstrong_r23_err] ])
          hiigalaxy.o32 = transpose([ [hii[indx].zstrong_o32], [hii[indx].zstrong_o32_err] ])
          hiigalaxy.p   = transpose([ [hii[indx].zstrong_p], [hii[indx].zstrong_p_err] ])

          hiigalaxy.log12oh_kk04_upper = transpose([ [hii[indx].zstrong_12oh_kk04_r23_upper], [hii[indx].zstrong_12oh_kk04_r23_upper_err] ])
          hiigalaxy.log12oh_kk04_lower = transpose([ [hii[indx].zstrong_12oh_kk04_r23_lower], [hii[indx].zstrong_12oh_kk04_r23_lower_err] ])
          hiigalaxy.log12oh_pt05_upper = transpose([ [hii[indx].zstrong_12oh_pt05_upper], [hii[indx].zstrong_12oh_pt05_upper_err] ])
          hiigalaxy.log12oh_pt05_lower = transpose([ [hii[indx].zstrong_12oh_pt05_lower], [hii[indx].zstrong_12oh_pt05_lower_err] ])

          hiigalaxy.log12oh_o3n2   = transpose([ [hii[indx].zstrong_12oh_oiiinii_niiha], [hii[indx].zstrong_12oh_oiiinii_niiha_err] ])
          hiigalaxy.log12oh_te     = transpose([ [hii[indx].zt_log12oh], [hii[indx].zt_log12oh_err] ])
          hiigalaxy.log12oh_te_lit = transpose([ [hii[indx].lit_log12oh_te], [hii[indx].lit_log12oh_te_err] ])

; assign all the HII regions the R23 branch of the galaxy

          hiigalaxy.r23_branch = result[k].r23_branch

; add a minimum abundance uncertainty to the Te abundances

          good = where((hiigalaxy.log12oh_te_lit[1] gt -900.0),ngood)
          if (ngood ne 0L) then hiigalaxy[good].log12oh_te_lit[1] = sqrt(hiigalaxy[good].log12oh_te_lit[1]^2.0 + ohte_minerr^2.0)

          good = where((hiigalaxy.log12oh_te[1] gt -900.0),ngood)
          if (ngood ne 0L) then hiigalaxy[good].log12oh_te[1] = sqrt(hiigalaxy[good].log12oh_te[1]^2.0 + ohte_minerr^2.0)

; add a minimum abundance uncertainty to the strong-line methods
          
          good = where((hiigalaxy.log12oh_kk04_upper[1] gt -900.0),ngood)
          if (ngood ne 0L) then hiigalaxy[good].log12oh_kk04_upper[1] = sqrt(hiigalaxy[good].log12oh_kk04_upper[1]^2.0 + oh_minerr^2.0)

          good = where((hiigalaxy.log12oh_kk04_lower[1] gt -900.0),ngood)
          if (ngood ne 0L) then hiigalaxy[good].log12oh_kk04_lower[1] = sqrt(hiigalaxy[good].log12oh_kk04_lower[1]^2.0 + oh_minerr^2.0)

          good = where((hiigalaxy.log12oh_pt05_upper[1] gt -900.0),ngood)
          if (ngood ne 0L) then hiigalaxy[good].log12oh_pt05_upper[1] = sqrt(hiigalaxy[good].log12oh_pt05_upper[1]^2.0 + oh_minerr^2.0)

          good = where((hiigalaxy.log12oh_pt05_lower[1] gt -900.0),ngood)
          if (ngood ne 0L) then hiigalaxy[good].log12oh_pt05_lower[1] = sqrt(hiigalaxy[good].log12oh_pt05_lower[1]^2.0 + oh_minerr^2.0)

          good = where((hiigalaxy.log12oh_o3n2[1] gt -900.0),ngood)
          if (ngood ne 0L) then hiigalaxy[good].log12oh_o3n2[1] = sqrt(hiigalaxy[good].log12oh_o3n2[1]^2.0 + oh_minerr^2.0)

; flag specific HII regions, and some HII regions as "ambigious" if
; the solution on the lower branch is larger than the upper branch
          
          case strtrim(result[k].galaxy,2) of
             'NGC2903': begin
                hiigalaxy[where((strmatch(strtrim(hiigalaxy.region,2),'-065-073',/fold) eq 1B) or $
                  (strmatch(strtrim(hiigalaxy.region,2),'-060-100',/fold) eq 1B) or $
                  (strmatch(strtrim(hiigalaxy.region,2),'-067-061',/fold) eq 1B) or $
                  (strmatch(strtrim(hiigalaxy.region,2),'-021+105',/fold) eq 1B) or $
                  (strmatch(strtrim(hiigalaxy.region,2),'+021+127',/fold) eq 1B))].r23_branch = 'X'
             end
             else: 
          endcase

          flag = where((hiigalaxy.log12oh_pt05_lower[0] gt -900.0) and (hiigalaxy.log12oh_pt05_upper[0] gt -900.0) and $
            (hiigalaxy.log12oh_pt05_lower[0] gt hiigalaxy.log12oh_pt05_upper[0]) and $
            ((hiigalaxy.log12oh_pt05_upper[0]+hiigalaxy.log12oh_pt05_upper[1]) lt $
            (hiigalaxy.log12oh_pt05_lower[0]-hiigalaxy.log12oh_pt05_lower[1])),nflag)
          if (nflag ne 0L) then hiigalaxy[flag].hii_pt05_r23_flag = 1L
   
          flag = where((hiigalaxy.log12oh_kk04_lower[0] gt -900.0) and (hiigalaxy.log12oh_kk04_upper[0] gt -900.0) and $
            (hiigalaxy.log12oh_kk04_lower[0] gt hiigalaxy.log12oh_kk04_upper[0]) and $
            ((hiigalaxy.log12oh_kk04_upper[0]+hiigalaxy.log12oh_kk04_upper[1]) lt $
            (hiigalaxy.log12oh_kk04_lower[0]-hiigalaxy.log12oh_kk04_lower[1])),nflag)
          if (nflag ne 0L) then hiigalaxy[flag].hii_kk04_r23_flag = 1L

; only compute abundance gradients for the following three galaxies:

          if strmatch(result[k].galaxy,'*ngc2903*',/fold) or strmatch(result[k].galaxy,'*ngc5236*',/fold) or $
            strmatch(result[k].galaxy,'*ic342*',/fold) then result[k].gradient_flag = 1L
          
          rr25_good = where((hiigalaxy.rc3_radius gt -900.0),nrr25_good)
          if (nrr25_good ne 0L) then result[k].hii_r25frac = max(hiigalaxy[rr25_good].rc3_rr25) - $
            min(hiigalaxy[rr25_good].rc3_rr25)

; compute the average PT05, KK04, and O3N2 abundances; also compute
; abundance gradients for particular galaxies

; KK04          
          
          kk04_avg = where((hiigalaxy.log12oh_kk04_upper[0] gt -900.0) and (hiigalaxy.log12oh_kk04_lower[0] gt -900.0) and $
            (hiigalaxy.hii_kk04_r23_flag eq 0L) and (hiigalaxy.rc3_rr25 lt rc3_rr25_max) and (strtrim(hiigalaxy.r23_branch,2) ne 'X'),nkk04_avg)
          if (nkk04_avg ne 0L) then begin

             up = where((hiigalaxy[kk04_avg].r23_branch eq 'U'),nup)
             if (nup ne 0L) then hiigalaxy[kk04_avg[up]].log12oh_kk04 = hiigalaxy[kk04_avg[up]].log12oh_kk04_upper
             lo = where((hiigalaxy[kk04_avg].r23_branch eq 'L'),nlo)
             if (nlo ne 0L) then hiigalaxy[kk04_avg[lo]].log12oh_kk04 = hiigalaxy[kk04_avg[lo]].log12oh_kk04_lower

             result[k].hii_kk04_nhii_used = nkk04_avg ; exclude ambigious objects

             kk04_texrefs = hiigalaxy[kk04_avg].texref
             kk04_texrefs = strtrim(kk04_texrefs[uniq(kk04_texrefs,sort(kk04_texrefs))],2)
             result[k].hii_kk04_texrefs = strjoin(kk04_texrefs,',')

             oh     = hiigalaxy[kk04_avg].log12oh_kk04[0]
             oh_err = hiigalaxy[kk04_avg].log12oh_kk04[1]
             if keyword_set(weighted_avg) then begin
                result[k].hii_kk04_log12oh_avg[0] = total(oh/oh_err^2.0)/total(1.0/oh_err^2.0)
                result[k].hii_kk04_log12oh_avg[1] = 1.0/sqrt(total(1.0/oh_err^2.0))
             endif else begin
                result[k].hii_kk04_log12oh_avg[0] = djs_mean(oh)
                if (nkk04_avg gt 1L) then $
                  result[k].hii_kk04_log12oh_avg[1] = djsig(oh)>median(oh_err) else $ ; NOTE!
;                 result[k].hii_kk04_log12oh_avg[1] = djsig(oh)/sqrt(nkk04_avg) else $
                    result[k].hii_kk04_log12oh_avg[1] = oh_err
             endelse

          endif 

; abundance gradient
          
          kk04_grad = where((hiigalaxy.log12oh_kk04[0] gt -900.0) and (hiigalaxy.rc3_rr25 gt -900.0) and $
            (hiigalaxy.rc3_rr25 lt rc3_rr25_max) and (result[k].gradient_flag eq 1L),nkk04_grad)
          if (nkk04_grad ne 0L) then begin

             rr25_kk04 = hiigalaxy[kk04_grad].rc3_rr25
             rr25_kk04_err = rr25_kk04*0.0
             result[k].hii_kk04_rr25_avg = [djs_mean(rr25_kk04),djsig(rr25_kk04)]

             oh_kk04 = hiigalaxy[kk04_grad].log12oh_kk04[0]
             oh_kk04_err = hiigalaxy[kk04_grad].log12oh_kk04[1]

             if (nkk04_grad ge nhii_min) and (result[k].hii_r25frac gt r25frac_min) then begin
                res_kk04 = sings_fit_gradient(rr25_kk04,rr25_kk04_err,$
                  oh_kk04,oh_kk04_err,nmonte=nmonte,xchar=rr25_char)
                result[k].hii_kk04_slope           = res_kk04.slope
                result[k].hii_kk04_slope_flag      = res_kk04.slope_flag
                result[k].hii_kk04_log12oh_central = res_kk04.int
                result[k].hii_kk04_log12oh_char    = res_kk04.ychar
             endif

          endif

; PT05
          
          pt05_avg = where((hiigalaxy.log12oh_pt05_upper[0] gt -900.0) and (hiigalaxy.log12oh_pt05_lower[0] gt -900.0) and $
            (hiigalaxy.hii_pt05_r23_flag eq 0L) and (hiigalaxy.rc3_rr25 lt rc3_rr25_max) and (strtrim(hiigalaxy.r23_branch,2) ne 'X'),npt05_avg)
          if (npt05_avg ne 0L) then begin

             p     = hiigalaxy[pt05_avg].p[0]
             p_err = hiigalaxy[pt05_avg].p[1]
             if keyword_set(weighted_avg) then begin
                result[k].hii_pt05_p_avg[0] = total(p/p_err^2.0)/total(1.0/p_err^2.0)
                result[k].hii_pt05_p_avg[1] = 1.0/sqrt(total(1.0/p_err^2.0))
             endif else begin
                result[k].hii_pt05_p_avg[0] = djs_mean(p)
                if (npt05_avg gt 1L) then $
                  result[k].hii_pt05_p_avg[1] = djsig(p)>median(p_err) else $ ; NOTE!
;                 result[k].hii_pt05_p_avg[1] = djsig(p)/sqrt(npt05_avg) else $
                    result[k].hii_pt05_p_avg[1] = p_err
             endelse

             up = where((hiigalaxy[pt05_avg].r23_branch eq 'U'),nup)
             if (nup ne 0L) then hiigalaxy[pt05_avg[up]].log12oh_pt05 = hiigalaxy[pt05_avg[up]].log12oh_pt05_upper
             lo = where((hiigalaxy[pt05_avg].r23_branch eq 'L'),nlo)
             if (nlo ne 0L) then hiigalaxy[pt05_avg[lo]].log12oh_pt05 = hiigalaxy[pt05_avg[lo]].log12oh_pt05_lower

             result[k].hii_pt05_nhii_used = npt05_avg ; exclude ambigious objects

             pt05_texrefs = hiigalaxy[pt05_avg].texref
             pt05_texrefs = strtrim(pt05_texrefs[uniq(pt05_texrefs,sort(pt05_texrefs))],2)
             result[k].hii_pt05_texrefs = strjoin(pt05_texrefs,',')

             oh     = hiigalaxy[pt05_avg].log12oh_pt05[0]
             oh_err = hiigalaxy[pt05_avg].log12oh_pt05[1]
             if keyword_set(weighted_avg) then begin
                result[k].hii_pt05_log12oh_avg[0] = total(oh/oh_err^2.0)/total(1.0/oh_err^2.0)
                result[k].hii_pt05_log12oh_avg[1] = 1.0/sqrt(total(1.0/oh_err^2.0))
             endif else begin
                result[k].hii_pt05_log12oh_avg[0] = djs_mean(oh)
                if (npt05_avg gt 1L) then $
                  result[k].hii_pt05_log12oh_avg[1] = djsig(oh)>median(oh_err) else $ ; NOTE!!
;                 result[k].hii_pt05_log12oh_avg[1] = djsig(oh)/sqrt(npt05_avg) else $
                    result[k].hii_pt05_log12oh_avg[1] = oh_err
             endelse

             if (npt05_avg gt 1L) then begin
;               struct_print, im_struct_trimtags(hiigalaxy[pt05_avg],select=['galaxy','ned_galaxy','region',$
;                 'r23_branch','log12oh_pt05','log12oh_o3n2','log12oh_te','log12oh_te_lit','reference'],newtags=['galaxy','ned_galaxy',$
;                 'region','branch','oh_pt05','oh_o3n2','oh_te','oh_te_lit','ref']) ;, no_head=(k gt 0L)
;               cc = get_kbrd(1)
             endif

          endif 

; abundance gradient
          
          pt05_grad = where((hiigalaxy.log12oh_pt05[0] gt -900.0) and (hiigalaxy.rc3_rr25 gt -900.0) and $
            (hiigalaxy.rc3_rr25 lt rc3_rr25_max) and (result[k].gradient_flag eq 1L),npt05_grad)
          if (npt05_grad ne 0L) then begin

             rr25_pt05 = hiigalaxy[pt05_grad].rc3_rr25
             rr25_pt05_err = rr25_pt05*0.0
             result[k].hii_pt05_rr25_avg = [djs_mean(rr25_pt05),djsig(rr25_pt05)]

             oh_pt05 = hiigalaxy[pt05_grad].log12oh_pt05[0]
             oh_pt05_err = hiigalaxy[pt05_grad].log12oh_pt05[1]

             if (npt05_grad ge nhii_min) and (result[k].hii_r25frac gt r25frac_min) then begin
                res_pt05 = sings_fit_gradient(rr25_pt05,rr25_pt05_err,$
                  oh_pt05,oh_pt05_err,nmonte=nmonte,xchar=rr25_char)
                result[k].hii_pt05_slope           = res_pt05.slope
                result[k].hii_pt05_slope_flag      = res_pt05.slope_flag
                result[k].hii_pt05_log12oh_central = res_pt05.int
                result[k].hii_pt05_log12oh_char    = res_pt05.ychar
             endif

;            djs_plot, [0], [0], /nodata, xrange=rr25range, yrange=ohrange, charsize=2.0
;            oploterror, rr25_pt05, oh_pt05, oh_pt05_err, ps=4

          endif

; O3N2
          
          o3n2_avg = where((hiigalaxy.log12oh_o3n2[0] gt -900.0) and (hiigalaxy.rc3_rr25 lt rc3_rr25_max) and $
            (strtrim(hiigalaxy.r23_branch,2) ne 'X'),no3n2_avg)
          if (no3n2_avg ne 0L) then begin

             result[k].hii_o3n2_nhii_used = no3n2_avg

             o3n2_texrefs = hiigalaxy[o3n2_avg].texref
             o3n2_texrefs = strtrim(o3n2_texrefs[uniq(o3n2_texrefs,sort(o3n2_texrefs))],2)
             result[k].hii_o3n2_texrefs = strjoin(o3n2_texrefs,',')

             oh     = hiigalaxy[o3n2_avg].log12oh_o3n2[0]
             oh_err = hiigalaxy[o3n2_avg].log12oh_o3n2[1]
             if keyword_set(weighted_avg) then begin
                result[k].hii_o3n2_log12oh_avg[0] = total(oh/oh_err^2.0)/total(1.0/oh_err^2.0)
                result[k].hii_o3n2_log12oh_avg[1] = 1.0/sqrt(total(1.0/oh_err^2.0))
             endif else begin
                result[k].hii_o3n2_log12oh_avg[0] = djs_mean(oh)
                if (no3n2_avg gt 1L) then $
                  result[k].hii_o3n2_log12oh_avg[1] = djsig(oh)>median(oh_err) else $ ; NOTE!!
;                 result[k].hii_o3n2_log12oh_avg[1] = djsig(oh)/sqrt(no3n2_avg) else $
                    result[k].hii_o3n2_log12oh_avg[1] = oh_err
             endelse
;            if strmatch(galaxy[k],'*3256*',/fold) then begin
;               print, result[k].hii_o3n2_log12oh_avg
;               stop
;            endif

          endif 

; abundance gradient
          
          o3n2_grad = where((hiigalaxy.log12oh_o3n2[0] gt -900.0) and (hiigalaxy.rc3_rr25 gt -900.0) and $
            (hiigalaxy.rc3_rr25 lt rc3_rr25_max) and (result[k].gradient_flag eq 1L),no3n2_grad)
          if (no3n2_grad ne 0L) then begin

             rr25_o3n2 = hiigalaxy[o3n2_grad].rc3_rr25
             rr25_o3n2_err = rr25_o3n2*0.0
             result[k].hii_o3n2_rr25_avg = [djs_mean(rr25_o3n2),djsig(rr25_o3n2)]

             oh_o3n2 = hiigalaxy[o3n2_grad].log12oh_o3n2[0]
             oh_o3n2_err = hiigalaxy[o3n2_grad].log12oh_o3n2[1]

             if (no3n2_grad ge nhii_min) and (result[k].hii_r25frac gt r25frac_min) then begin
                res_o3n2 = sings_fit_gradient(rr25_o3n2,rr25_o3n2_err,$
                  oh_o3n2,oh_o3n2_err,nmonte=nmonte,xchar=rr25_char)
                result[k].hii_o3n2_slope           = res_o3n2.slope
                result[k].hii_o3n2_slope_flag      = res_o3n2.slope_flag
                result[k].hii_o3n2_log12oh_central = res_o3n2.int
                result[k].hii_o3n2_log12oh_char    = res_o3n2.ychar
             endif

          endif

; store the Te abundances, if any

; average electron temperature abundances, except the abundance
; gradient galaxies (i.e., NGC2903, NGC5236=M83), which have a handful
; of (non-representative) HII regions with measured electron
; temperatures; there's also a temporary hack here to adopt the
; published (literature value) of the electron temperature and oxygen
; abundance, mostly from Izotov et 2006 and Kniazev et 2004 of SDSS
; galaxies without [OII] 3727 detections (here, the Te was derived
; from the [OII] 7375 doublet)

          good_te = where(((hiigalaxy.log12oh_te[0] gt -900.0) or (hiigalaxy.log12oh_te_lit[0] gt -900.0)),ngood_te)
          if (ngood_te ne 0L) then begin

;            if (max(abs(hiigalaxy[good_te].log12oh_te_lit[0]-djs_median(hiigalaxy[good_te].log12oh_te_lit[0]))) gt 0.01) then begin
;               struct_print, im_struct_trimtags(hiigalaxy[good_te],select=['galaxy','ned_galaxy','region',$
;                 'r23_branch','log12oh_pt05','log12oh_o3n2','log12oh_te','log12oh_te_lit','reference'],newtags=['galaxy','ned_galaxy',$
;                 'region','branch','oh_pt05','oh_o3n2','oh_te','oh_te_lit','ref']) ;, no_head=(k gt 0L)
;               cc = get_kbrd(1)
;            endif

             flag = where(((hiigalaxy[good_te].log12oh_te_lit[0] gt -900.0) and (hiigalaxy[good_te].log12oh_te[0] lt -900.0)),nflag)
;            flag = where(((hiigalaxy[good_te].log12oh_te_lit[0] gt -900.0) and (hiigalaxy[good_te].log12oh_te[0] lt -900.0)) or $
;              ((hiigalaxy[good_te].log12oh_te_lit[0] lt -900.0) and (hiigalaxy[good_te].log12oh_te[0] gt -900.0)),nflag)
             if (nflag gt 0L) then begin

;               struct_print, im_struct_trimtags(hiigalaxy[good_te],select=['galaxy','ned_galaxy','region',$
;                 'r23_branch','log12oh_pt05','log12oh_o3n2','log12oh_te','log12oh_te_lit','reference'],newtags=['galaxy','ned_galaxy',$
;                 'region','branch','oh_pt05','oh_o3n2','oh_te','oh_te_lit','ref']) ;, no_head=(k gt 0L)
;               cc = get_kbrd(1)             

                oh = [-999.0]
                oh_err = [-999.0]
                te_texrefs = ['']
                
                oh_lit = where((hiigalaxy[good_te].log12oh_te[0] lt -900.0) and (hiigalaxy[good_te].log12oh_te_lit[0] gt -900.0),$
                  noh_lit,comp=oh_me,ncomp=noh_me)
                if (noh_lit ne 0L) then begin
                   oh         = [oh,hiigalaxy[good_te[oh_lit]].log12oh_te_lit[0]]
                   oh_err     = [oh_err,hiigalaxy[good_te[oh_lit]].log12oh_te_lit[1]]
                   te_texrefs = [te_texrefs,hiigalaxy[good_te[oh_lit]].texref]
                endif
                if (noh_me ne 0L) then begin
                   oh         = [oh,hiigalaxy[good_te[oh_me]].log12oh_te[0]]
                   oh_err     = [oh_err,hiigalaxy[good_te[oh_me]].log12oh_te[1]]
                   te_texrefs = [te_texrefs,hiigalaxy[good_te[oh_me]].texref]
                endif

                ngood_te = n_elements(oh)-1L ; offset
                result[k].hii_te_nhii_used = ngood_te
                
                oh         = oh[1L:ngood_te]
                oh_err     = oh_err[1L:ngood_te]

                te_texrefs = te_texrefs[1L:ngood_te]
                te_texrefs = strtrim(te_texrefs[uniq(te_texrefs,sort(te_texrefs))],2)
                result[k].hii_te_texrefs = strjoin(te_texrefs,',')
                
             endif else begin
             
                result[k].hii_te_nhii_used = ngood_te

                te_texrefs = hiigalaxy[good_te].texref
                te_texrefs = strtrim(te_texrefs[uniq(te_texrefs,sort(te_texrefs))],2)
                result[k].hii_te_texrefs = strjoin(te_texrefs,',')

                oh     = hiigalaxy[good_te].log12oh_te[0]
                oh_err = hiigalaxy[good_te].log12oh_te[1]

             endelse             

             if keyword_set(weighted_avg) then begin
                result[k].hii_te_log12oh_avg[0] = total(oh/oh_err^2.0)/total(1.0/oh_err^2.0)
                result[k].hii_te_log12oh_avg[1] = 1.0/sqrt(total(1.0/oh_err^2.0))
             endif else begin
                result[k].hii_te_log12oh_avg[0] = djs_mean(oh)
                if (ngood_te gt 1L) then $
                  result[k].hii_te_log12oh_avg[1] = djsig(oh)>median(oh_err) else $ ; NOTE!!
;                 result[k].hii_te_log12oh_avg[1] = djsig(oh)/sqrt(ngood_te) else $
                    result[k].hii_te_log12oh_avg[1] = oh_err
             endelse
;            if strmatch(galaxy[k],'*izw18*',/fold) then stop

          endif
          
;         good_te = where((hiigalaxy.log12oh_te_lit[0] gt -900.0) or (hiigalaxy.log12oh_te[0] gt -900.0),ngood_te)
;         if (ngood_te gt 0L) then begin
;
;            flag = where(((hiigalaxy[good_te].log12oh_te_lit[0] gt -900.0) and (hiigalaxy[good_te].log12oh_te[0] lt -900.0)) or $
;              ((hiigalaxy[good_te].log12oh_te_lit[0] lt -900.0) and (hiigalaxy[good_te].log12oh_te[0] gt -900.0)),nflag)
;            if (nflag gt 0L) then begin
;               struct_print, im_struct_trimtags(hiigalaxy[good_te],select=['galaxy','ned_galaxy','region',$
;                 'r23_branch','log12oh_pt05','log12oh_o3n2','log12oh_te','log12oh_te_lit','reference'],newtags=['galaxy','ned_galaxy',$
;                 'region','branch','oh_pt05','oh_o3n2','oh_te','oh_te_lit','ref']) ;, no_head=(k gt 0L)
;               cc = get_kbrd(1)             
;            endif
;            
;         endif

; concatenate the HIIGALAXY structure          
          
          if (n_elements(allhiigalaxy) eq 0L) then allhiigalaxy = hiigalaxy else allhiigalaxy = [allhiigalaxy,hiigalaxy]

       endif                    ; close the HII-region logical statement

    endfor

    allhiigalaxy.number = lindgen(n_elements(allhiigalaxy))+1L ; unique ID number

; ---------------------------------------------------------------------------    
; construct the final set of metallicities
; ---------------------------------------------------------------------------        
    
; ##########
; HII/Te
; ##########

    oh_te = where((result.hii_te_log12oh_avg[0] gt -900.0) and (result.log12oh_final lt -900.0) and $
      (result.gradient_flag eq 0L),noh_te)
    result[oh_te].log12oh_final         = result[oh_te].hii_te_log12oh_avg[0]
    result[oh_te].log12oh_final_err     = result[oh_te].hii_te_log12oh_avg[1]
    result[oh_te].log12oh_final_ref     = result[oh_te].hii_te_texrefs
    result[oh_te].log12oh_final_comment = 'HII/Direct'

; ##########
; HII/PT05
; ##########

    oh_pt05 = where((result.hii_pt05_log12oh_avg[0] gt -900.0) and (result.hii_pt05_p_avg[0] gt -900.0) and $ ; NOTE!
      (result.hii_pt05_p_avg[0] gt 0.4) and (result.log12oh_final lt -900.0) and $
      (result.gradient_flag eq 0L),noh_pt05)
    result[oh_pt05].log12oh_final         = result[oh_pt05].hii_pt05_log12oh_avg[0]
    result[oh_pt05].log12oh_final_err     = result[oh_pt05].hii_pt05_log12oh_avg[1]
    result[oh_pt05].log12oh_final_ref     = result[oh_pt05].hii_pt05_texrefs
    result[oh_pt05].log12oh_final_comment = 'HII/PT05'

; ##########
; HII/O3N2
; ##########

    oh_o3n2 = where((result.hii_pt05_log12oh_avg[0] gt -900.0) and (result.hii_pt05_p_avg[0] gt -900.0) and $ ; NOTE!
      (result.hii_pt05_p_avg[0] lt 0.4) and (result.log12oh_final lt -900.0) and $
      (result.gradient_flag eq 0L) and (result.hii_o3n2_log12oh_avg[0] gt -900.0),noh_o3n2)
    result[oh_o3n2].log12oh_final         = result[oh_o3n2].hii_o3n2_log12oh_avg[0]
    result[oh_o3n2].log12oh_final_err     = result[oh_o3n2].hii_o3n2_log12oh_avg[1]
    result[oh_o3n2].log12oh_final_ref     = result[oh_o3n2].hii_o3n2_texrefs
    result[oh_o3n2].log12oh_final_comment = 'HII/O3N2'

; ##########
; MK06/PT05     
; ##########

    mk06_pt05 = where((result.atlas_log12oh_pt05[0] gt -900.0) and (result.atlas_p[0] gt -900.0) and $
      (result.atlas_p[0] gt 0.4) and (result.log12oh_final lt -900.0) and $
      (result.gradient_flag eq 0L),nmk06_pt05)
    result[mk06_pt05].log12oh_final         = result[mk06_pt05].atlas_log12oh_pt05[0]
    result[mk06_pt05].log12oh_final_err     = result[mk06_pt05].atlas_log12oh_pt05[1]
    result[mk06_pt05].log12oh_final_ref     = 'This_paper'
    result[mk06_pt05].log12oh_final_comment = 'MK06/PT05'

; ##########
; MK06/O3N2
; ##########

    mk06_o3n2 = where((result.atlas_log12oh_pt05[0] gt -900.0) and (result.atlas_p[0] gt -900.0) and $
      (result.atlas_p[0] lt 0.4) and (result.log12oh_final lt -900.0) and $
      (result.gradient_flag eq 0L),nmk06_o3n2)
    result[mk06_o3n2].log12oh_final         = result[mk06_o3n2].atlas_log12oh_o3n2[0]
    result[mk06_o3n2].log12oh_final_err     = result[mk06_o3n2].atlas_log12oh_o3n2[1]
    result[mk06_o3n2].log12oh_final_ref     = 'This_paper'
    result[mk06_o3n2].log12oh_final_comment = 'MK06/O3N2'

; ##########
; other!
; ##########

    kug1013 = speclinefit_locate(result,['KUG1013+381'])
    result[kug1013].log12oh_final         = 7.58
    result[kug1013].log12oh_final_err     = 0.15
    result[kug1013].log12oh_final_ref     = 'kniazev98'
    result[kug1013].log12oh_final_comment = 'Original_value'

    sbs1102 = speclinefit_locate(result,['SBS1102+606'])
    result[sbs1102].log12oh_final         = 7.64
    result[sbs1102].log12oh_final_err     = 0.04
    result[sbs1102].log12oh_final_ref     = 'kniazev03'
    result[sbs1102].log12oh_final_comment = 'Original_value'
    
    n2903 = speclinefit_locate(result,['NGC2903'])
    result[n2903].log12oh_final         = 8.68
    result[n2903].log12oh_final_err     = 0.05
    result[n2903].log12oh_final_ref     = 'pilyugin06'
    result[n2903].log12oh_final_comment = 'Original_value'
    
    n5236 = speclinefit_locate(result,['NGC5236']) ; =M83
    result[n5236].log12oh_final         = 8.62
    result[n5236].log12oh_final_err     = 0.01
    result[n5236].log12oh_final_ref     = 'pilyugin06'
    result[n5236].log12oh_final_comment = 'Original_value'
    
    ic342 = speclinefit_locate(result,['IC342'])
    result[ic342].log12oh_final         = 8.85
    result[ic342].log12oh_final_err     = 0.05
    result[ic342].log12oh_final_ref     = 'pilyugin04a'
    result[ic342].log12oh_final_comment = 'Original_value'
    
; check for what's left!    
    
;   more = where(result.log12oh_final gt -900.0,comp=less)
;   srt = sort(result[more].log12oh_final)
;   struct_print, struct_trimtags(result[more[srt]],select=['GALAXY','NED_GALAXY','R23_BRANCH',$
;     'CHAD_LOG12OH','LOG12OH_FINAL*'])
;
;   if (less[0] ne -1L) then begin
;      splog, '###########################################################################'
;      struct_print, struct_trimtags(result[less],select=['GALAXY','NED_GALAXY','R23_BRANCH',$
;        'CHAD_LOG12OH','LOG12OH_FINAL*'])
;   endif

; ##################################################
; make some plots
; ##################################################

; compare PT05 and O3N2 for non-Te galaxies; e.g., NGC3256: probably
; use O3N2
    
; compare my metallicities against Chad's

    if keyword_set(write) then begin
       postthick1 = 4.0
       postthick2 = 3.0
       dfpsplot, outpath+'gto_log12oh_'+version+'.ps', xsize=8.5, ysize=9.0
    endif else begin
       postthick1 = 2.0
       postthick2 = 2.0
       im_window, 0, xratio=0.4, /square
    endelse

    charsize = 1.9
    ohrange = [6.8,9.2]
    
    pagemaker, nx=1, ny=2, yspace=0, xspace=0, xmargin=[1.3,0.2], $
      ymargin=[0.4,1.1], position=pos, width=7.0, height=[4.5,3.0], $
      ypage=9.0, xpage=8.5, /normal

    djs_plot, [0], [0], /nodata, xthick=postthick1, ythick=postthick1, /xsty, /ysty, $
      charsize=charsize, charthick=postthick2, xtitle='', xtickname=replicate(' ',10), $
      ytitle='12 + log (O/H) [Chad]', xrange=ohrange, yrange=ohrange, position=pos[*,0]
    oplot, !x.crange, !y.crange, thick=postthick1
    plotsym, 8, 1, /fill
    oploterror, result.log12oh_final, result.chad_log12oh, result.log12oh_final_err, $
      result.chad_log12oh_err, ps=8, thick=postthick1, errthick=postthick1

    djs_plot, [0], [0], /nodata, /noerase, xthick=postthick1, ythick=postthick1, /xsty, /ysty, $
      charsize=charsize, charthick=postthick2, xtitle='12 + log (O/H) [Moustakas]', $
      ytitle='Residuals', xrange=ohrange, yrange=[-0.5,0.5], position=pos[*,1]
    oplot, !x.crange, [0,0], thick=postthick1
    plotsym, 8, 1.4, /fill
    oplot, result.log12oh_final, result.chad_log12oh-result.log12oh_final, ps=8

    if keyword_set(write) then dfpsclose; else cc = get_kbrd(1)

; ##################################################
; write out    
; ##################################################
    
    if keyword_set(write) then begin
       outfile = 'gto_log12oh_'+version+'.fits'
       splog, 'Writing '+outpath+outfile+'.'
       mwrfits, result, outpath+outfile, /create
       spawn, 'gzip -f '+outpath+outfile, /sh

       outfile = 'gto_log12oh_hiiregions_'+version+'.fits'
       splog, 'Writing '+outpath+outfile+'.'
       mwrfits, allhiigalaxy, outpath+outfile, /create
       spawn, 'gzip -f '+outpath+outfile, /sh
    endif

    srt = sort(result.log12oh_final)
    final_result = im_struct_trimtags(result[srt],select=['GALAXY','NED_GALAXY',$
      'CHAD_LOG12OH*','LOG12OH_FINAL*'])
    struct_print, final_result

; write out the ASCII file without the "nice" galaxy name    
    
    if keyword_set(write) then begin
       txtoutfile = repstr(outfile,'.fits','.dat')
       splog, 'Writing '+outpath+txtoutfile+'.'
       openw, lun, outpath+txtoutfile, /get_lun
       printf, lun, '## Nebular Abundances of the GTO Starbursts'
       printf, lun, '## John Moustakas, john.moustakas@nyu.edu, '+im_today()
;      printf, lun, '## PROVISIONAL/NOT FOR DISTRIBUTION'
       printf, lun, '## '+version
;      printf, lun, '## Discarded or "no measurement" are indicated using -999.'
       printf, lun, '# 1 Galaxy'
       printf, lun, '# 2 NED_Galaxy'
       printf, lun, '# 3 Log12oh_Chad'
       printf, lun, '# 4 Log12oh_Chad_Err'
       printf, lun, '# 5 Log12oh_Moustakas'
       printf, lun, '# 6 Log12oh_Moustakas_Err'
       printf, lun, '# 7 Log12oh_Moustakas_Ref'
       printf, lun, '# 8 Log12oh_Moustakas_Comment'
       struct_print, final_result, lun=lun, /no_head
       free_lun, lun
    endif

    final_result = im_struct_trimtags(result[srt],select=['GALAXY','NED_GALAXY',$
      'NICE_GALAXY','CHAD_LOG12OH*','LOG12OH_FINAL*','DISTANCE*'])

    if keyword_set(write) then begin
       outfile = 'gto_log12oh_final_'+version+'.fits'
       splog, 'Writing '+outpath+outfile+'.'
       mwrfits, final_result, outpath+outfile, /create
       spawn, 'gzip -f '+outpath+outfile, /sh
    endif
    
; ###########################################################################    
    

    
;; compare Te and PT05 abundances    
;    
;    oh_te = where(strmatch(result.log12oh_final_comment,'*direct*',/fold) and (result.hii_pt05_log12oh_avg[0] gt -900.0),noh_te)
;    if (noh_te ne 0L) then begin
;       srt = sort(result[oh_te].hii_te_log12oh_avg[0])
;;      struct_print, struct_trimtags(result[oh_te[srt]],select=['GALAXY','NED_GALAXY','R23_BRANCH',$
;;        'HII_PT05_LOG12OH_AVG','HII_TE_LOG12OH_AVG','HII_TE_NHII_USED','HII_TE_TEXREFS'])
;       ploterror, result[oh_te].hii_te_log12oh_avg[0], result[oh_te].hii_pt05_log12oh_avg[0], $
;         result[oh_te].hii_te_log12oh_avg[1], result[oh_te].hii_pt05_log12oh_avg[1], $
;         ps=4, xr=[7,9], yr=[7,9], /xsty, /ysty
;       oplot, !x.crange, !y.crange, thick=2
;       cc = get_kbrd(1)
;    endif
;
;; compare Te and O3N2 abundances    
;    
;    oh_te = where(strmatch(result.log12oh_final_comment,'*direct*',/fold) and (result.hii_o3n2_log12oh_avg[0] gt -900.0),noh_te)
;    if (noh_te ne 0L) then begin
;       srt = sort(result[oh_te].hii_te_log12oh_avg[0])
;;      struct_print, struct_trimtags(result[oh_te[srt]],select=['GALAXY','NED_GALAXY','R23_BRANCH',$
;;        'HII_O3N2_LOG12OH_AVG','HII_TE_LOG12OH_AVG','HII_TE_NHII_USED','HII_TE_TEXREFS'])
;       ploterror, result[oh_te].hii_te_log12oh_avg[0], result[oh_te].hii_o3n2_log12oh_avg[0], $
;         result[oh_te].hii_te_log12oh_avg[1], result[oh_te].hii_o3n2_log12oh_avg[1], $
;         ps=4, xr=[7,9], yr=[7,9], /xsty, /ysty
;       oplot, !x.crange, !y.crange, thick=2
;       cc = get_kbrd(1)
;    endif

return
end 

;;;;pro gto_log12oh, gto, hii, allgto_atlas, allgto_atlas_nodust, result, plotavg=plotavg, silent=silent, $
;;;;  debug=debug, blackwhite=blackwhite, encapsulated=encapsulated, postscript=postscript
;;;;; jm06dec12nyu - written
;;;;
;;;;    splog, 'ADD A SYSTEMATIC UNCERTAINTY -- SEE GTO_LOG12OH - jm07feb19nyu'
;;;;    
;;;;stop    
;;;;    
;;;;    version = gto_log12oh_version()
;;;;    
;;;;    plot_kk04 = 1L
;;;;    plot_pt05 = 1L
;;;;;   plot_o3n2 = 1L
;;;;
;;;;    snrcut_class = 3.0
;;;;    snrcut_log12oh = 3.0
;;;;    
;;;;; (oxygen or "O/H") and (abundance or metallicity)
;;;;; (oxygen or "O/H" or "HII") and (abundance or metallicity)
;;;;      
;;;;    outpath = gto_path()
;;;;    pspath = gto_path()+'FIG_GTO/'
;;;;
;;;;    if (n_elements(gto) eq 0L) then gto = gto_read_ancillary()
;;;;    if (n_elements(hii) eq 0L) then hii = mrdfits(outpath+'gto_hiiregions_'+version+'.fits.gz',1,/silent)
;;;;
;;;;    if (n_elements(allgto_atlas) eq 0L) then allgto_atlas = read_gto_atlas_sample(datanodust=allgto_atlas_nodust)
;;;;
;;;;; LZ relation defined by HII regions    
;;;;    
;;;;    if file_test(outpath+'hiilzfit.fits',/regular) then begin
;;;;       splog, 'Reading '+outpath+'hiilzfit.fits.'
;;;;       hiilzfit = mrdfits(outpath+'hiilzfit.fits',1,/silent)
;;;;    endif
;;;;
;;;;    branchinfo = rsex(outpath+'gto_r23branch.sex')
;;;;    classinfo = rsex(outpath+'gto_class.sex')
;;;;
;;;;    ngalaxy = n_elements(gto)
;;;;    nhii = n_elements(hii)
;;;;
;;;;    if keyword_set(postscript) then nmonte = 500L else nmonte = 3L
;;;;    rr25axis = findgen(51)/10.0
;;;;    rr25_char = 0.4
;;;;    nhii_min = 5L
;;;;    r25frac_min = 0.3 ; minimum HII-region disk covering fraction
;;;;    r23_cut = 1.1
;;;;    rc3_rr25_max = 1.0 ; 2.0
;;;;    
;;;;    sigma_rej = 3.0
;;;;    maxrej = 1.0
;;;;
;;;;    ohrange = [7.0,9.7]
;;;;;   ohrange = [7.5,9.7]
;;;;;   ohrange = [7.4,9.5]
;;;;    ohrange2 = [6.8,9.9]
;;;;    ohrange3 = [7.5,9.6]
;;;;    rr25range = [-0.1,1.2>rc3_rr25_max] ; [-0.1,1.6] ; [-0.2,1.9]
;;;;    niiharange = [-2.3,0.6]
;;;;    oiiihbrange = [-1.1,1.2] ; [-1.2,1.3]
;;;;    r23range = [-0.5,1.6]
;;;;
;;;;    hiigalaxy1 = {$
;;;;
;;;;      galaxy:                               '', $
;;;;      ned_galaxy:                           '', $
;;;;      hii_galaxy:                           '', $
;;;;      region:                               '', $
;;;;
;;;;      log12oh_kk04:       [-999.0,-999.0], $
;;;;      log12oh_pt05:       [-999.0,-999.0], $
;;;;      log12oh_o3n2:       [-999.0,-999.0], $
;;;;      log12oh_te:         [-999.0,-999.0], $ ; electron temperature
;;;;      
;;;;      log12oh_pt05_upper: [-999.0,-999.0], $
;;;;      log12oh_kk04_upper: [-999.0,-999.0], $
;;;;      log12oh_pt05_lower: [-999.0,-999.0], $
;;;;      log12oh_kk04_lower: [-999.0,-999.0], $
;;;;
;;;;      hii_kk04_r23_flag:                    0L, $ ; lower branch solution greater than upper branch
;;;;      hii_pt05_r23_flag:                    0L, $ ; lower branch solution greater than upper branch
;;;;
;;;;      n2:                      [-999.0,-999.0], $
;;;;      n2o2:                    [-999.0,-999.0], $
;;;;      r23_branch:                          '?', $
;;;;      rc3_radius:                       -999.0, $
;;;;      rc3_rr25:                         -999.0, $
;;;;      twomass_radius:                   -999.0, $
;;;;      twomass_rr25:                     -999.0, $
;;;;      texref:                               '', $
;;;;      reference:                            ''}
;;;;    
;;;;; initialize the output data structure    
;;;;    
;;;;    result = {$
;;;;
;;;;      galaxy:                                  '', $
;;;;      atlas_galaxy:                            '', $
;;;;      ned_galaxy:                              '', $
;;;;      nice_galaxy:                             '', $
;;;;      ebv_mw:                              -999.0, $
;;;;      m_b:                                 -999.0, $
;;;;      distance:                            -999.0, $
;;;;      distance_err:                        -999.0, $
;;;;      distance_ref:                            '', $
;;;;      type:                                    '', $
;;;;      t:                                      0.0, $
;;;;      d25:                                 -999.0, $
;;;;      r25:                                 -999.0, $
;;;;      incl:                                -999.0, $
;;;;      pa:                                  -999.0, $
;;;;      gradient_flag:                           0L, $ ; abundance gradient? (0 or 1)
;;;;      class:                                   '', $ ; final spectral class
;;;;      class_remarks:                           '', $
;;;;;     ho_class:                         '\nodata', $ ; spectral class from Ho et al. 1997
;;;;                                       
;;;;      hii_nhii:                                0L, $ ; number of HII regions
;;;;      hii_r25frac:                            0.0, $ ; fraction of the R25 radius spanned by the HII regions
;;;;
;;;;      hii_kk04_nhii_used:                      0L, $ ; number of HII regions used
;;;;      hii_kk04_slope:             [-999.0,-999.0], $ ; KK04 abundance gradient slope
;;;;      hii_kk04_slope_flag:                     0L, $ ; formal positive slope
;;;;      hii_kk04_log12oh_central:   [-999.0,-999.0], $ ; KK04 abundance gradient intercept
;;;;      hii_kk04_log12oh_char:      [-999.0,-999.0], $ ; characteristic KK04 metallicity (R=0.4R25)
;;;;      hii_kk04_log12oh_avg:       [-999.0,-999.0], $ ; average KK04 metallicity
;;;;      hii_kk04_rr25_avg:          [-999.0,-999.0], $ ; average RR25 position of the KK04 metallicity
;;;;      hii_kk04_texrefs:                        '', $ ; references
;;;;
;;;;      hii_pt05_nhii_used:                      0L, $ ; number of HII regions used
;;;;      hii_pt05_slope:             [-999.0,-999.0], $ ; PT05 abundance gradient slope
;;;;      hii_pt05_slope_flag:                     0L, $ ; formal positive slope
;;;;      hii_pt05_log12oh_central:   [-999.0,-999.0], $ ; PT05 abundance gradient intercept
;;;;      hii_pt05_log12oh_char:      [-999.0,-999.0], $ ; characteristic PT05 metallicity (R=0.4R25)
;;;;      hii_pt05_log12oh_avg:       [-999.0,-999.0], $ ; average PT05 metallicity
;;;;      hii_pt05_rr25_avg:          [-999.0,-999.0], $ ; average RR25 position of the PT05 metallicity
;;;;      hii_pt05_texrefs:                        '', $ ; references
;;;;                                  
;;;;      hii_o3n2_nhii_used:                      0L, $ ; number of HII regions used
;;;;      hii_o3n2_slope:             [-999.0,-999.0], $ ; O3N2 abundance gradient slope
;;;;      hii_o3n2_slope_flag:                     0L, $ ; formal positive slope
;;;;      hii_o3n2_log12oh_central:   [-999.0,-999.0], $ ; O3N2 abundance gradient intercept
;;;;      hii_o3n2_log12oh_char:      [-999.0,-999.0], $ ; characteristic O3N2 metallicity (R=0.4R25)
;;;;      hii_o3n2_log12oh_avg:       [-999.0,-999.0], $ ; average O3N2 metallicity
;;;;      hii_o3n2_rr25_avg:          [-999.0,-999.0], $ ; average RR25 position of the O3N2 metallicity
;;;;      hii_o3n2_texrefs:                        '', $ ; references
;;;;                                      
;;;;      hii_te_nhii_used:                        0L, $ ; number of HII regions used
;;;;      hii_te_log12oh_avg:         [-999.0,-999.0], $ ; average Te metallicity
;;;;      hii_te_texrefs:                          '', $ ; references
;;;;      
;;;;      r23_branch:                             '?', $
;;;;      
;;;;      gto_atlas:                               0L, $ ; Boolean flag
;;;;      gto_atlas_ebv:              [-999.0,-999.0], $
;;;;      gto_atlas_class:                        '?', $ ; the default is insufficient data
;;;;      gto_atlas_ewhb:                      -999.0, $
;;;;      gto_atlas_ewhb_abs:                  -999.0, $
;;;;      gto_atlas_log12oh_kk04:     [-999.0,-999.0], $
;;;;      gto_atlas_log12oh_pt05:     [-999.0,-999.0], $
;;;;      gto_atlas_log12oh_o3n2:     [-999.0,-999.0], $
;;;;      gto_atlas_r23:              [-999.0,-999.0], $
;;;;      gto_atlas_p:                [-999.0,-999.0], $
;;;;
;;;;      drift20:                                 0L, $ ; Boolean flag
;;;;      drift20_ebv:                [-999.0,-999.0], $
;;;;      drift20_class:                          '?', $
;;;;      drift20_ewhb:                        -999.0, $
;;;;      drift20_ewhb_abs:                    -999.0, $
;;;;      drift20_log12oh_kk04:       [-999.0,-999.0], $
;;;;      drift20_log12oh_pt05:       [-999.0,-999.0], $
;;;;      drift20_log12oh_o3n2:       [-999.0,-999.0], $
;;;;      drift20_r23:                [-999.0,-999.0], $
;;;;      drift20_p:                  [-999.0,-999.0], $
;;;;
;;;;      drift56:                                 0L, $ ; Boolean flag
;;;;      drift56_ebv:                [-999.0,-999.0], $
;;;;      drift56_class:                          '?', $
;;;;      drift56_ewhb:                        -999.0, $
;;;;      drift56_ewhb_abs:                    -999.0, $
;;;;      drift56_log12oh_kk04:       [-999.0,-999.0], $
;;;;      drift56_log12oh_pt05:       [-999.0,-999.0], $
;;;;      drift56_log12oh_o3n2:       [-999.0,-999.0], $
;;;;      drift56_r23:                [-999.0,-999.0], $
;;;;      drift56_p:                  [-999.0,-999.0], $
;;;;
;;;;      log12oh_pt05_char:          [-999.0,-999.0], $
;;;;      log12oh_pt05_char_comment:            '...', $
;;;;;     log12oh_pt05_central:       [-999.0,-999.0], $
;;;;;     log12oh_pt05_central_comment:         '...', $
;;;;      
;;;;      log12oh_kk04_char:          [-999.0,-999.0], $
;;;;      log12oh_kk04_char_comment:            '...'}
;;;;;     log12oh_kk04_central:       [-999.0,-999.0], $
;;;;;     log12oh_kk04_central_comment:         '...', $
;;;;      
;;;;    result = replicate(result,ngalaxy)
;;;;    
;;;;    result.galaxy       = gto.galaxy
;;;;    result.ned_galaxy   = gto.ned_galaxy
;;;;    result.nice_galaxy  = gto.galaxy
;;;;    result.ebv_mw       = gto.ebv_mw
;;;;    result.type         = strtrim(gto.lit_type,2)
;;;;    result.t            = gto.lit_t
;;;;    result.d25          = gto.d25_maj
;;;;    result.r25          = gto.d25_maj/2.0
;;;;    result.m_b          = gto.rc3_m_b
;;;;    result.distance     = gto.distance
;;;;    result.distance_err = gto.distance_err
;;;;    result.distance_ref = repstr(repstr(repstr(strtrim(gto.distance_ref,2),' ','_'),',',''),'.','')
;;;;
;;;;    result.class         = classinfo.class
;;;;    result.class_remarks = classinfo.class_remarks
;;;;
;;;;    result.r23_branch = branchinfo.r23_branch
;;;;
;;;;; inclination and position angles: priority: RC3, then 2MASS; set the
;;;;; inclination angle of NGC5194 to be 20, the kinematic value (Tully
;;;;; 1974); also set the inclination and position angles according to Lee
;;;;; et al. (2006)
;;;;    
;;;;;   result.incl = gto.inclination
;;;;;   result.pa   = gto.posangle
;;;;
;;;;; apply S/N cuts
;;;;
;;;;    gto_atlas_keep = where($
;;;;      (allgto_atlas.h_alpha[0]  /allgto_atlas.h_alpha[1]   gt snrcut_log12oh) and $
;;;;      (allgto_atlas.h_beta[0]   /allgto_atlas.h_beta[1]    gt snrcut_log12oh) and $
;;;;      (allgto_atlas.oii_3727[0] /allgto_atlas.oii_3727[1]  gt snrcut_log12oh) and $
;;;;      (allgto_atlas.oiii_5007[0]/allgto_atlas.oiii_5007[1] gt snrcut_log12oh),ngto_atlas_keep)
;;;;
;;;;    gto_atlas = allgto_atlas[gto_atlas_keep]
;;;;    gto_atlas_nodust = allgto_atlas_nodust[gto_atlas_keep]
;;;;
;;;;    splog, 'GTO/ATLAS: '+string(ngto_atlas_keep,format='(I0)')+'/'+$
;;;;      string(n_elements(allgto_atlas),format='(I0)')+$
;;;;      ' galaxies made the S/N cuts.'
;;;;
;;;;;   cut = cmset_op(strtrim(allgto_atlas.galaxy,2),'and',/not2,strtrim(gto_atlas.galaxy,2),/index)
;;;;;   niceprint, allgto_atlas[cut].galaxy, allgto_atlas[cut].galaxy
;;;;
;;;;;   niceprint, allgto_atlas.galaxy, allgto_atlas.galaxy, allgto_atlas.h_alpha[0]/allgto_atlas.h_alpha[1], $
;;;;;     allgto_atlas.h_beta[0]/allgto_atlas.h_beta[1], allgto_atlas.oii_3727[0]/allgto_atlas.oii_3727[1], $
;;;;;     allgto_atlas.oiii_5007[0]/allgto_atlas.oiii_5007[1]
;;;;    
;;;;    
;;;;; move on     
;;;;    
;;;;    galaxy = strtrim(result.galaxy,2)
;;;;
;;;;    if keyword_set(postscript) then debug = 0L
;;;;    if keyword_set(debug) then im_window, 0, xratio=0.45, /square
;;;;    
;;;;; ---------------------------------------------------------------------------        
;;;;; initialize abundance gradient plotting variables
;;;;; ---------------------------------------------------------------------------    
;;;;
;;;;    xrange = rr25range
;;;;    yrange = ohrange
;;;;    xtitle = '\rho / \rho_{25}'       
;;;;    ytitle = '12 + log (O/H)'
;;;;;   plotsym, 0, 1.0, /fill
;;;;
;;;;    o3n2_psym = 8L
;;;;    pt05_psym = 8L
;;;;    kk04_psym = 0L
;;;;
;;;;    if keyword_set(blackwhite) then o3n2_color = 'black' else o3n2_color = 'blue'
;;;;    if keyword_set(blackwhite) then pt05_color = 'black' else pt05_color = 'blue'
;;;;    if keyword_set(blackwhite) then kk04_color = 'black' else kk04_color = 'red'
;;;;
;;;;    avg_psym = 4 & avg_color = 'grey'
;;;;    
;;;;    if keyword_set(postscript) then begin
;;;;
;;;;       postthick = 8.0 
;;;;       postthick2 = 4.0 
;;;;       postthick3 = 4.0 
;;;;       pcharsize = 2.2
;;;;       pcharsize2 = 2.2
;;;;       pcharsize3 = 1.8
;;;;       lcharsize = 1.0
;;;;       lcharsize2 = 1.5
;;;;       psize = 0.8
;;;;       psize2 = 0.8
;;;;       psize3 = 1.2
;;;;       psize4 = 1.8
;;;;
;;;;    endif else begin
;;;;
;;;;       postthick = 2.0 
;;;;       postthick2 = 2.0 
;;;;       postthick3 = 2.0 
;;;;       pcharsize = 1.8
;;;;       pcharsize2 = 2.0
;;;;       lcharsize = 1.8
;;;;       lcharsize2 = 2.0
;;;;       psize = 1.3
;;;;       psize2 = 3.0
;;;;       psize3 = 1.7
;;;;
;;;;    endelse
;;;;
;;;;; ---------------------------------------------------------------------------
;;;;; generate some plots
;;;;; ---------------------------------------------------------------------------
;;;;
;;;;    if keyword_set(debug) or keyword_set(postscript) then begin
;;;;    
;;;;; ###########
;;;;; BPT diagram       
;;;;; ###########
;;;;       
;;;;       if keyword_set(blackwhite) then suffix = '_blackwhite' else suffix = ''
;;;;       psname = 'gto_niiha_vs_oiiihb'+suffix
;;;;
;;;;       im_openclose, pspath+psname, postscript=postscript, xsize=8.5, ysize=8.3, encapsulated=encapsulated
;;;;
;;;;       pagemaker, nx=1, ny=1, xspace=0, yspace=0.0, width=6.6, height=6.6, $
;;;;         xmargin=[1.5,0.4], ymargin=[0.6,1.1], xpage=8.5, ypage=8.3, $
;;;;         position=pos, /normal
;;;;
;;;;       lineratio, allgto_atlas, 'NII_6584', 'H_ALPHA', 'OIII_5007', 'H_BETA', $
;;;;         x, xerr, y, yerr, index=indx, snrcut=snrcut_class ; NOTE S/N cut!
;;;;
;;;;       sf = where(strtrim(allgto_atlas.bpt_nii_mixture_class,2) eq 'HII')
;;;;       lineratio, allgto_atlas[sf], 'NII_6584', 'H_ALPHA', 'OIII_5007', 'H_BETA', $
;;;;         xsf, xerrsf, ysf, yerrsf, index=indxsf, snrcut=snrcut_class ; NOTE S/N cut!
;;;;
;;;;;      agn = where(strtrim(allgto_atlas.bpt_nii_mixture_class,2) eq 'AGN')
;;;;;      lineratio, allgto_atlas[agn], 'NII_6584', 'H_ALPHA', 'OIII_5007', 'H_BETA', $
;;;;;        xagn, xerragn, yagn, yerragn, index=indxagn, snrcut=snrcut_class ; NOTE S/N cut!
;;;;
;;;;       mix = where(strtrim(allgto_atlas.bpt_nii_mixture_class,2) eq 'HII/AGN')
;;;;       lineratio, allgto_atlas[mix], 'NII_6584', 'H_ALPHA', 'OIII_5007', 'H_BETA', $
;;;;         xmix, xerrmix, ymix, yerrmix, index=indxmix, snrcut=snrcut_class ; NOTE S/N cut!
;;;;
;;;;       atlas1d_lineplot, xsf, ysf, xerrsf, yerrsf, plottype=1, $
;;;;         postscript=postscript, xtitle='log ([N II] \lambda6584/H\alpha)', $
;;;;         ytitle='log ([O III] \lambda5007/H\beta)', xrange=niiharange, $
;;;;         yrange=oiiihbrange, position=pos[*,0], $
;;;;         atlascolor='blue', atlassym=108, atlaspsize=psize3
;;;;;      atlas1d_lineplot, xagn, yagn, xerragn, yerragn, /overplot, $
;;;;;        atlascolor='blue', atlassym=108, atlaspsize=psize3
;;;;       atlas1d_lineplot, xmix, ymix, xerrmix, yerrmix, /overplot, $
;;;;         atlascolor='blue', atlassym=108, atlaspsize=psize3
;;;;
;;;;; overplot the mixing lines
;;;;
;;;;       models = kewley_bpt_lines(/kauffmann,_extra=extra)
;;;;       oplot, models.x_nii, models.y_nii, line=0, thick=postthick
;;;;       models = kewley_bpt_lines(_extra=extra)
;;;;       oplot, models.x_nii, models.y_nii, line=2, thick=postthick
;;;;
;;;;; label       
;;;;       
;;;;       for ii = 0L, n_elements(x)-1L do begin
;;;;          gal = strtrim(allgto_atlas[indx[ii]].galaxy,2)
;;;;          align = 0.0 & xoff = +0.05 & yoff = 0.0
;;;;          if strmatch(gal,'*ngc1614*',/fold) then begin
;;;;             align = 0.0 & xoff = +0.05 & yoff = -0.02
;;;;          endif
;;;;          if strmatch(gal,'*ngc2146*',/fold) then begin
;;;;             align = 0.0 & xoff = +0.05 & yoff = +0.02
;;;;          endif
;;;;          xyouts, x[ii]+xoff, y[ii]+yoff, gal, /data, charsize=1.0, charthick=1.3, align=align
;;;;       endfor
;;;;       
;;;;       im_openclose, postscript=postscript, /close
;;;;
;;;;    endif
;;;;
;;;;; open the GTO_GRADIENTS postscript file
;;;;       
;;;;    if keyword_set(postscript) then begin
;;;;
;;;;       if keyword_set(blackwhite) then suffix = '_blackwhite' else suffix = ''
;;;;
;;;;       if keyword_set(encapsulated) then $
;;;;         psname = 'gto_gradients'+suffix+'.eps' else $
;;;;         psname = 'gto_gradients'+suffix+'.ps'
;;;;
;;;;;; 5x5 panels       
;;;;;       
;;;;;       ncols = 5L & nrows = 5L
;;;;;       xspace = 0.0 & yspace = 0.0
;;;;;       xmargin = [0.7,0.3] & ymargin = [0.3,0.7]
;;;;;       width = 1.5 & height = 1.5
;;;;;       xpage = 8.5 & ypage = 8.5
;;;;       
;;;;; 5x6 panels       
;;;;       
;;;;       ncols = 5L & nrows = 6L
;;;;       xspace = 0.0 & yspace = 0.0
;;;;       xmargin = [0.8,0.3] & ymargin = [0.3,0.8]
;;;;       width = 1.48 & height = 1.65
;;;;       xpage = 8.5 & ypage = 11.0
;;;;       
;;;;; 4x6 panels       
;;;;       
;;;;;      ncols = 4L & nrows = 6L
;;;;;      xspace = 0.0 & yspace = 0.0
;;;;;      xmargin = [0.8,0.3] & ymargin = [0.3,0.8]
;;;;;      width = 1.85 & height = 1.65
;;;;;      xpage = 8.5 & ypage = 11.0
;;;;       
;;;;       arm_plotconfig, nx=ncols, ny=nrows, xmargin=xmargin, $
;;;;         ymargin=ymargin, xspace=xspace, yspace=yspace, width=width, $
;;;;         height=height, coord=pos, xpage=xpage, ypage=ypage, $
;;;;         psfile=pspath+psname, /writeover
;;;;       cleanplot, /silent
;;;;
;;;;    endif
;;;;
;;;;; ---------------------------------------------------------------------------    
;;;;; loop on each object
;;;;; ---------------------------------------------------------------------------    
;;;;
;;;;    gradient_counter = 0L
;;;;
;;;;    for k = 47, ngalaxy-1L do begin
;;;;;   for k = 0L, ngalaxy-1L do begin
;;;;
;;;;;      print, k, gto[k].galaxy
;;;;       
;;;;; ###########################################################################
;;;;; store the nuclear, circumnuclear, and radial strip abundances
;;;;; ###########################################################################
;;;;
;;;;       match = where(strtrim(result[k].ned_galaxy,2) eq strtrim(gto_atlas.ned_galaxy,2),nmatch)
;;;;       if (nmatch ne 0L) then begin
;;;;
;;;;          result[k].gto_atlas          = 1L
;;;;          result[k].atlas_galaxy       = gto_atlas[match].galaxy
;;;;          result[k].gto_atlas_ebv      = [gto_atlas_nodust[match].ebv_hahb,gto_atlas_nodust[match].ebv_hahb_err]
;;;;          result[k].gto_atlas_r23      = [gto_atlas_nodust[match].zstrong_r23,gto_atlas_nodust[match].zstrong_r23_err]
;;;;          result[k].gto_atlas_p        = [gto_atlas_nodust[match].zstrong_p,gto_atlas_nodust[match].zstrong_p_err]
;;;;          result[k].gto_atlas_ewhb     = gto_atlas[match].h_beta_ew[0]
;;;;          result[k].gto_atlas_ewhb_abs = gto_atlas[match].babs_h_beta_ew[0]
;;;;
;;;;          if (result[k].r23_branch eq 'U') and (strtrim(result[k].class,2) ne 'AGN') then begin
;;;;             result[k].gto_atlas_log12oh_pt05 = [gto_atlas_nodust[match].log12oh_pt05_upper,gto_atlas_nodust[match].log12oh_pt05_upper_err]
;;;;             result[k].gto_atlas_log12oh_kk04 = [gto_atlas_nodust[match].log12oh_kk04_r23_upper,gto_atlas_nodust[match].log12oh_kk04_r23_upper_err]
;;;;          endif
;;;;
;;;;          if (result[k].r23_branch eq 'L') and (strtrim(result[k].class,2) ne 'AGN')  then begin
;;;;             result[k].gto_atlas_log12oh_pt05 = [gto_atlas_nodust[match].log12oh_pt05_lower,gto_atlas_nodust[match].log12oh_pt05_lower_err]
;;;;             result[k].gto_atlas_log12oh_kk04 = [gto_atlas_nodust[match].log12oh_kk04_r23_lower,gto_atlas_nodust[match].log12oh_kk04_r23_lower_err]
;;;;          endif
;;;;
;;;;          if (result[k].r23_branch eq 'A') and (strtrim(result[k].class,2) ne 'AGN') then begin
;;;;             splog, 'Fix me!'
;;;;             stop
;;;;          endif
;;;;
;;;;          result[k].gto_atlas_log12oh_o3n2 = [gto_atlas[match].log12oh_oiiinii_niiha,gto_atlas[match].log12oh_oiiinii_niiha_err]
;;;;
;;;;       endif
;;;;
;;;;; ##################################################
;;;;; does this galaxy have any HII-region measurements?
;;;;; ##################################################
;;;;
;;;;       indx = where(strtrim(strupcase(result[k].ned_galaxy),2) eq strtrim(strupcase(hii.ned_galaxy),2),nindx)
;;;;       if (nindx eq 0L) then begin
;;;;
;;;;          if (not keyword_set(silent)) then splog, 'No HII-region data for '+strtrim(result[k].galaxy,2)+'.' 
;;;;
;;;;       endif else begin
;;;;
;;;;          result[k].hii_nhii = nindx
;;;;
;;;;; fill the HII-region structure for this galaxy
;;;;
;;;;          hiigalaxy                = replicate(hiigalaxy1,nindx)
;;;;          hiigalaxy.galaxy         = strtrim(result[k].galaxy,2)
;;;;          hiigalaxy.ned_galaxy     = strtrim(hii[indx].ned_galaxy,2)
;;;;          hiigalaxy.hii_galaxy     = strtrim(hii[indx].hii_galaxy,2)
;;;;          hiigalaxy.region         = strtrim(hii[indx].hii_region,2)
;;;;          hiigalaxy.reference      = hii[indx].reference
;;;;          hiigalaxy.texref         = hii[indx].texref
;;;;          hiigalaxy.rc3_radius     = hii[indx].hii_rc3_radius
;;;;          hiigalaxy.rc3_rr25       = hii[indx].hii_rc3_rr25
;;;;          hiigalaxy.twomass_radius = hii[indx].hii_twomass_radius
;;;;          hiigalaxy.twomass_rr25   = hii[indx].hii_twomass_rr25
;;;;
;;;;          hiigalaxy.n2   = transpose([ [hii[indx].zstrong_niiha], [hii[indx].zstrong_niiha_err] ])
;;;;          hiigalaxy.n2o2 = transpose([ [hii[indx].zstrong_niioii], [hii[indx].zstrong_niioii_err] ])
;;;;
;;;;          hiigalaxy.log12oh_kk04_upper = transpose([ [hii[indx].log12oh_kk04_r23_upper], [hii[indx].log12oh_kk04_r23_upper_err] ])
;;;;          hiigalaxy.log12oh_kk04_lower = transpose([ [hii[indx].log12oh_kk04_r23_lower], [hii[indx].log12oh_kk04_r23_lower_err] ])
;;;;          hiigalaxy.log12oh_pt05_upper = transpose([ [hii[indx].log12oh_pt05_upper], [hii[indx].log12oh_pt05_upper_err] ])
;;;;          hiigalaxy.log12oh_pt05_lower = transpose([ [hii[indx].log12oh_pt05_lower], [hii[indx].log12oh_pt05_lower_err] ])
;;;;
;;;;          hiigalaxy.log12oh_o3n2 = transpose([ [hii[indx].log12oh_oiiinii_niiha], [hii[indx].log12oh_oiiinii_niiha_err] ])
;;;;          hiigalaxy.log12oh_te = transpose([ [hii[indx].zt_log12oh], [hii[indx].zt_log12oh_err] ])
;;;;
;;;;; average electron temperature abundances
;;;;
;;;;          good_te = where(hiigalaxy.log12oh_te[0] gt -900.0,ngood_te)
;;;;          if (ngood_te ne 0L) then begin
;;;;
;;;;             result[k].hii_te_nhii_used = ngood_te
;;;;
;;;;             te_texrefs = hiigalaxy[good_te].texref
;;;;             te_texrefs = strtrim(te_texrefs[uniq(te_texrefs,sort(te_texrefs))],2)
;;;;             result[k].hii_te_texrefs = strjoin(te_texrefs,',')
;;;;
;;;;             oh     = hiigalaxy[good_te].log12oh_te[0]
;;;;             oh_err = hiigalaxy[good_te].log12oh_te[1]
;;;;             result[k].hii_te_log12oh_avg[0] = djs_mean(oh)
;;;;             if (ngood_te gt 1L) then $
;;;;               result[k].hii_te_log12oh_avg[1] = djsig(oh)/sqrt(ngood_te) else $
;;;;                 result[k].hii_te_log12oh_avg[1] = oh_err
;;;;
;;;;;            niceprint, hiigalaxy[good_te].region, oh, oh_err, hiigalaxy[good_te].reference
;;;;;            cc = get_kbrd(1)
;;;;
;;;;          endif
;;;;          
;;;;; ##################################################
;;;;; figure out the appropriate branch for each HII region
;;;;; ##################################################
;;;;
;;;;; assign all the HII regions the R23 branch of the galaxy, or exclude
;;;;; certain HII regions
;;;;
;;;;          hiigalaxy.r23_branch = result[k].r23_branch
;;;;
;;;;          case galaxy[k] of
;;;;             'NGC7331': begin
;;;;             end
;;;;             'NGC1156': begin
;;;;             end
;;;;             'NGC0224': begin
;;;;             end
;;;;             'NGC2903': begin
;;;;             end
;;;;             'NGC3310': begin
;;;;             end
;;;;             'NGC5236': begin
;;;;             end
;;;;             'DDO187': begin
;;;;             end
;;;;             'NGC0598': begin
;;;;             end
;;;;             'NGC4214': begin
;;;;             end
;;;;             'NGC1569': begin
;;;;             end
;;;;             'NGC3031': begin
;;;;                hiigalaxy[where($
;;;;                  (strmatch(strtrim(hiigalaxy.region,2),'Muench1',/fold) eq 1B) or $
;;;;                  (strmatch(strtrim(hiigalaxy.region,2),'Munch1',/fold) eq 1B))].r23_branch = 'X' ; controversial
;;;;             end
;;;;             'NGC4449': begin
;;;;             end
;;;;             'NGC5457': begin
;;;;             end
;;;;             'NGC4861': begin
;;;;             end
;;;;             'VIIZW403': begin
;;;;             end
;;;;             'NGC5055': begin
;;;;             end
;;;;             else: 
;;;;          endcase 
;;;;
;;;;; flag HII regions as "ambigious" if the solution on the lower branch
;;;;; is larger than the upper branch
;;;;          
;;;;          flag = where((hiigalaxy.log12oh_pt05_lower[0] gt -900.0) and (hiigalaxy.log12oh_pt05_upper[0] gt -900.0) and $
;;;;            (hiigalaxy.log12oh_pt05_lower[0] gt hiigalaxy.log12oh_pt05_upper[0]) and $
;;;;            ((hiigalaxy.log12oh_pt05_upper[0]+hiigalaxy.log12oh_pt05_upper[1]) lt $
;;;;            (hiigalaxy.log12oh_pt05_lower[0]-hiigalaxy.log12oh_pt05_lower[1])),nflag)
;;;;          if (nflag ne 0L) then hiigalaxy[flag].hii_pt05_r23_flag = 1L
;;;;   
;;;;          flag = where((hiigalaxy.log12oh_kk04_lower[0] gt -900.0) and (hiigalaxy.log12oh_kk04_upper[0] gt -900.0) and $
;;;;            (hiigalaxy.log12oh_kk04_lower[0] gt hiigalaxy.log12oh_kk04_upper[0]) and $
;;;;            ((hiigalaxy.log12oh_kk04_upper[0]+hiigalaxy.log12oh_kk04_upper[1]) lt $
;;;;            (hiigalaxy.log12oh_kk04_lower[0]-hiigalaxy.log12oh_kk04_lower[1])),nflag)
;;;;          if (nflag ne 0L) then hiigalaxy[flag].hii_kk04_r23_flag = 1L
;;;;;         struct_print, struct_trimtags(hiigalaxy[flag],selec=['galaxy','*region*','*kk04*'])
;;;;
;;;;; ##################################################
;;;;; compute the average metallicity and the abundance gradient 
;;;;; ##################################################
;;;;
;;;;          rr25_good = where((hiigalaxy.rc3_radius gt -900.0),nrr25_good)
;;;;          if (nrr25_good ne 0L) then result[k].hii_r25frac = max(hiigalaxy[rr25_good].rc3_rr25) - $
;;;;            min(hiigalaxy[rr25_good].rc3_rr25)
;;;;             
;;;;; --------------------------------------------------
;;;;; KK04
;;;;; --------------------------------------------------
;;;;
;;;;; average metallicity                
;;;;stop             
;;;;          kk04_avg = where((hiigalaxy.log12oh_kk04_upper[0] gt -900.0) and (hiigalaxy.log12oh_kk04_lower[0] gt -900.0) and $
;;;;            (hiigalaxy.hii_kk04_r23_flag eq 0L) and (hiigalaxy.rc3_rr25 lt rc3_rr25_max) and (strtrim(hiigalaxy.r23_branch,2) ne 'X'),nkk04_avg)
;;;;          if (nkk04_avg ne 0L) then begin
;;;;
;;;;             up = where((hiigalaxy[kk04_avg].r23_branch eq 'U'),nup)
;;;;             if (nup ne 0L) then hiigalaxy[kk04_avg[up]].log12oh_kk04 = hiigalaxy[kk04_avg[up]].log12oh_kk04_upper
;;;;             lo = where((hiigalaxy[kk04_avg].r23_branch eq 'L'),nlo)
;;;;             if (nlo ne 0L) then hiigalaxy[kk04_avg[lo]].log12oh_kk04 = hiigalaxy[kk04_avg[lo]].log12oh_kk04_lower
;;;;
;;;;             result[k].hii_kk04_nhii_used = nkk04_avg ; exclude ambigious objects
;;;;
;;;;             kk04_texrefs = hiigalaxy[kk04_avg].texref
;;;;             kk04_texrefs = strtrim(kk04_texrefs[uniq(kk04_texrefs,sort(kk04_texrefs))],2)
;;;;             result[k].hii_kk04_texrefs = strjoin(kk04_texrefs,',')
;;;;
;;;;             oh     = hiigalaxy[kk04_avg].log12oh_kk04[0]
;;;;             oh_err = hiigalaxy[kk04_avg].log12oh_kk04[1]
;;;;             result[k].hii_kk04_log12oh_avg[0] = djs_mean(oh)
;;;;             if (nkk04_avg gt 1L) then $
;;;;               result[k].hii_kk04_log12oh_avg[1] = djsig(oh)/sqrt(nkk04_avg) else $
;;;;                 result[k].hii_kk04_log12oh_avg[1] = oh_err
;;;;;            result[k].hii_kk04_log12oh_avg[0] = total(oh/oh_err^2)/total(1.0/oh_err^2)
;;;;;            result[k].hii_kk04_log12oh_avg[1] = 1.0/sqrt(total(1.0/oh_err^2))
;;;;
;;;;;            if strmatch(galaxy[k],'*holmbergii*',/fold) then stop
;;;;
;;;;          endif 
;;;;
;;;;; abundance gradient; also require that RR25 be measured
;;;;          
;;;;          kk04_grad = where((hiigalaxy.log12oh_kk04[0] gt -900.0) and (hiigalaxy.rc3_rr25 gt -900.0) and $
;;;;            (hiigalaxy.rc3_rr25 lt rc3_rr25_max),nkk04_grad)
;;;;          if (nkk04_grad ne 0L) then begin
;;;;
;;;;             rr25_kk04 = hiigalaxy[kk04_grad].rc3_rr25
;;;;             rr25_kk04_err = rr25_kk04*0.0
;;;;             result[k].hii_kk04_rr25_avg = [djs_mean(rr25_kk04),djsig(rr25_kk04)]
;;;;
;;;;             oh_kk04 = hiigalaxy[kk04_grad].log12oh_kk04[0]
;;;;             oh_kk04_err = hiigalaxy[kk04_grad].log12oh_kk04[1]
;;;;
;;;;             if (nkk04_grad ge nhii_min) and (result[k].hii_r25frac gt r25frac_min) then begin
;;;;                res_kk04 = sings_fit_gradient(rr25_kk04,rr25_kk04_err,$
;;;;                  oh_kk04,oh_kk04_err,nmonte=nmonte,xchar=rr25_char)
;;;;                result[k].hii_kk04_slope           = res_kk04.slope
;;;;                result[k].hii_kk04_slope_flag      = res_kk04.slope_flag
;;;;                result[k].hii_kk04_log12oh_central = res_kk04.int
;;;;                result[k].hii_kk04_log12oh_char    = res_kk04.ychar
;;;;             endif
;;;;
;;;;             result[k].gradient_flag = 1L
;;;;             gradient_counter = gradient_counter + 1L ; note!
;;;;             
;;;;          endif
;;;;
;;;;; --------------------------------------------------
;;;;; PT05
;;;;; --------------------------------------------------
;;;;          
;;;;; average metallicity                
;;;;
;;;;          pt05_avg = where((hiigalaxy.log12oh_pt05_upper[0] gt -900.0) and (hiigalaxy.log12oh_pt05_lower[0] gt -900.0) and $
;;;;            (hiigalaxy.hii_pt05_r23_flag eq 0L) and (hiigalaxy.rc3_rr25 lt rc3_rr25_max) and (strtrim(hiigalaxy.r23_branch,2) ne 'X'),npt05_avg)
;;;;          if (npt05_avg ne 0L) then begin
;;;;
;;;;             up = where((hiigalaxy[pt05_avg].r23_branch eq 'U'),nup)
;;;;             if (nup ne 0L) then hiigalaxy[pt05_avg[up]].log12oh_pt05 = hiigalaxy[pt05_avg[up]].log12oh_pt05_upper
;;;;             lo = where((hiigalaxy[pt05_avg].r23_branch eq 'L'),nlo)
;;;;             if (nlo ne 0L) then hiigalaxy[pt05_avg[lo]].log12oh_pt05 = hiigalaxy[pt05_avg[lo]].log12oh_pt05_lower
;;;;
;;;;             result[k].hii_pt05_nhii_used = npt05_avg ; exclude ambigious objects
;;;;
;;;;             pt05_texrefs = hiigalaxy[pt05_avg].texref
;;;;             pt05_texrefs = strtrim(pt05_texrefs[uniq(pt05_texrefs,sort(pt05_texrefs))],2)
;;;;             result[k].hii_pt05_texrefs = strjoin(pt05_texrefs,',')
;;;;
;;;;             oh     = hiigalaxy[pt05_avg].log12oh_pt05[0]
;;;;             oh_err = hiigalaxy[pt05_avg].log12oh_pt05[1]
;;;;             result[k].hii_pt05_log12oh_avg[0] = djs_mean(oh)
;;;;             if (npt05_avg gt 1L) then $
;;;;               result[k].hii_pt05_log12oh_avg[1] = djsig(oh)/sqrt(npt05_avg) else $
;;;;                 result[k].hii_pt05_log12oh_avg[1] = oh_err
;;;;;            result[k].hii_pt05_log12oh_avg[0] = total(oh/oh_err^2)/total(1.0/oh_err^2)
;;;;;            result[k].hii_pt05_log12oh_avg[1] = 1.0/sqrt(total(1.0/oh_err^2))
;;;;
;;;;          endif 
;;;;
;;;;; abundance gradient; also require that RR25 be measured
;;;;          
;;;;          pt05_grad = where((hiigalaxy.log12oh_pt05[0] gt -900.0) and (hiigalaxy.rc3_rr25 gt -900.0) and $
;;;;            (hiigalaxy.rc3_rr25 lt rc3_rr25_max),npt05_grad)
;;;;          if (npt05_grad ne 0L) then begin
;;;;
;;;;             rr25_pt05 = hiigalaxy[pt05_grad].rc3_rr25
;;;;             rr25_pt05_err = rr25_pt05*0.0
;;;;             result[k].hii_pt05_rr25_avg = [djs_mean(rr25_pt05),djsig(rr25_pt05)]
;;;;
;;;;             oh_pt05 = hiigalaxy[pt05_grad].log12oh_pt05[0]
;;;;             oh_pt05_err = hiigalaxy[pt05_grad].log12oh_pt05[1]
;;;;
;;;;             if (npt05_grad ge nhii_min) and (result[k].hii_r25frac gt r25frac_min) then begin
;;;;                res_pt05 = sings_fit_gradient(rr25_pt05,rr25_pt05_err,$
;;;;                  oh_pt05,oh_pt05_err,nmonte=nmonte,xchar=rr25_char)
;;;;                result[k].hii_pt05_slope           = res_pt05.slope
;;;;                result[k].hii_pt05_slope_flag      = res_pt05.slope_flag
;;;;                result[k].hii_pt05_log12oh_central = res_pt05.int
;;;;                result[k].hii_pt05_log12oh_char    = res_pt05.ychar
;;;;             endif
;;;;
;;;;          endif
;;;;
;;;;; --------------------------------------------------
;;;;; O3N2
;;;;; --------------------------------------------------
;;;;          
;;;;; average metallicity                
;;;;
;;;;          o3n2_avg = where((hiigalaxy.log12oh_o3n2[0] gt -900.0) and (hiigalaxy.rc3_rr25 lt rc3_rr25_max) and $
;;;;            (strtrim(hiigalaxy.r23_branch,2) ne 'X'),no3n2_avg)
;;;;          if (no3n2_avg ne 0L) then begin
;;;;
;;;;             result[k].hii_o3n2_nhii_used = no3n2_avg
;;;;
;;;;             o3n2_texrefs = hiigalaxy[o3n2_avg].texref
;;;;             o3n2_texrefs = strtrim(o3n2_texrefs[uniq(o3n2_texrefs,sort(o3n2_texrefs))],2)
;;;;             result[k].hii_o3n2_texrefs = strjoin(o3n2_texrefs,',')
;;;;
;;;;             oh     = hiigalaxy[o3n2_avg].log12oh_o3n2[0]
;;;;             oh_err = hiigalaxy[o3n2_avg].log12oh_o3n2[1]
;;;;             result[k].hii_o3n2_log12oh_avg[0] = djs_mean(oh)
;;;;             if (no3n2_avg gt 1L) then $
;;;;               result[k].hii_o3n2_log12oh_avg[1] = djsig(oh)/sqrt(no3n2_avg) else $
;;;;                 result[k].hii_o3n2_log12oh_avg[1] = oh_err
;;;;;            result[k].hii_o3n2_log12oh_avg[0] = total(oh/oh_err^2)/total(1.0/oh_err^2)
;;;;;            result[k].hii_o3n2_log12oh_avg[1] = 1.0/sqrt(total(1.0/oh_err^2))
;;;;
;;;;          endif 
;;;;
;;;;; abundance gradient; also require that RR25 be measured
;;;;          
;;;;          o3n2_grad = where((hiigalaxy.log12oh_o3n2[0] gt -900.0) and (hiigalaxy.rc3_rr25 gt -900.0) and $
;;;;            (hiigalaxy.rc3_rr25 lt rc3_rr25_max),no3n2_grad)
;;;;          if (no3n2_grad ne 0L) then begin
;;;;
;;;;             rr25_o3n2 = hiigalaxy[o3n2_grad].rc3_rr25
;;;;             rr25_o3n2_err = rr25_o3n2*0.0
;;;;             result[k].hii_o3n2_rr25_avg = [djs_mean(rr25_o3n2),djsig(rr25_o3n2)]
;;;;
;;;;             oh_o3n2 = hiigalaxy[o3n2_grad].log12oh_o3n2[0]
;;;;             oh_o3n2_err = hiigalaxy[o3n2_grad].log12oh_o3n2[1]
;;;;
;;;;             if (no3n2_grad ge nhii_min) and (result[k].hii_r25frac gt r25frac_min) then begin
;;;;                res_o3n2 = sings_fit_gradient(rr25_o3n2,rr25_o3n2_err,$
;;;;                  oh_o3n2,oh_o3n2_err,nmonte=nmonte,xchar=rr25_char)
;;;;                result[k].hii_o3n2_slope           = res_o3n2.slope
;;;;                result[k].hii_o3n2_slope_flag      = res_o3n2.slope_flag
;;;;                result[k].hii_o3n2_log12oh_central = res_o3n2.int
;;;;                result[k].hii_o3n2_log12oh_char    = res_o3n2.ychar
;;;;             endif
;;;;
;;;;          endif
;;;;
;;;;; --------------------------------------------------
;;;;; plot the abundance gradient
;;;;; --------------------------------------------------
;;;;
;;;;          if keyword_set(debug) or keyword_set(postscript) and result[k].gradient_flag then begin
;;;;
;;;;             if keyword_set(postscript) then begin
;;;;
;;;;                if ((gradient_counter-1L) mod ncols) eq 0L then begin
;;;;                   delvarx, ytickname
;;;;                   ytitle1 = ytitle
;;;;                endif else begin
;;;;                   ytickname = replicate(' ',10)
;;;;                   ytitle1 = ''
;;;;                endelse
;;;;
;;;;                if (gradient_counter ge 25L) then begin
;;;;                   delvarx, xtickname
;;;;                   xtitle1 = xtitle
;;;;                endif else begin
;;;;                   xtickname = replicate(' ',10)
;;;;                   xtitle1 = ''
;;;;                endelse
;;;;                
;;;;                noerase = (gradient_counter gt 1L)
;;;;                position = pos[*,gradient_counter-1L]
;;;;
;;;;             endif else begin
;;;;
;;;;                xtitle1 = xtitle
;;;;                ytitle1 = ytitle
;;;;                noerase = 0L
;;;;                
;;;;             endelse
;;;;
;;;;             if ((nkk04_grad ne 0L) and keyword_set(plot_kk04)) or $
;;;;               ((npt05_grad ne 0L) and keyword_set(plot_pt05)) then begin
;;;;                
;;;;                djs_plot, [0], [0], /nodata, xthick=postthick, ythick=postthick, charsize=pcharsize, $
;;;;                  charthick=postthick2, thick=postthick, xtitle=xtitle1, ytitle=ytitle1, $
;;;;                  xstyle=3, ystyle=1, xrange=xrange, yrange=yrange, position=position, $
;;;;                  ytickname=ytickname, xtickname=xtickname, noerase=noerase, xtickinterval=0.5
;;;;                legend, strtrim(result[k].nice_galaxy,2), /right, /bottom, box=0, $
;;;;                  charsize=lcharsize, charthick=postthick3, spacing=-1.0, margin=-0.3
;;;;
;;;;             endif
;;;;                
;;;;; -------------------------                
;;;;; KK04
;;;;; -------------------------                
;;;;             if (nkk04_grad ne 0L) and keyword_set(plot_kk04) then begin
;;;;                plotsym, kk04_psym, psize, fill=1L, thick=postthick2
;;;;                if keyword_set(errorbars) then oploterror, rr25_kk04, oh_kk04, rr25_kk04_err, oh_kk04_err, $
;;;;                  ps=8, color=djs_icolor(kk04_color), errcolor=djs_icolor(kk04_color), thick=postthick2 else begin
;;;;                   if (nkk04_grad eq 1L) then $
;;;;                     plots, rr25_kk04, oh_kk04, ps=8, color=djs_icolor(kk04_color) else $
;;;;                       djs_oplot, rr25_kk04, oh_kk04, ps=8, color=djs_icolor(kk04_color)
;;;;                endelse 
;;;;                ambig_kk04 = where((hiigalaxy.hii_kk04_r23_flag),nambig_kk04)
;;;;                if (nambig_kk04 ne 0L) then begin
;;;;                   plotsym, kk04_psym, psize, fill=0L, thick=postthick2
;;;;                   for ii = 0L, nambig_kk04-1L do begin
;;;;                      xkk04 = hiigalaxy[ambig_kk04[ii]].rc3_rr25
;;;;                      ykk04_up = hiigalaxy[ambig_kk04[ii]].log12oh_kk04_upper[0]
;;;;                      ykk04_lo = hiigalaxy[ambig_kk04[ii]].log12oh_kk04_lower[0]
;;;;;                     print, xkk04, ykk04_up, ykk04_lo
;;;;                      djs_oplot, xkk04*[1,1], [ykk04_up,ykk04_lo], $
;;;;                        ps=-8, line=0, thick=postthick2, color=djs_icolor(kk04_color)
;;;;                   endfor
;;;;                endif
;;;;                exclude_kk04 = where((hiigalaxy.r23_branch eq 'X'),nexclude_kk04)
;;;;                if (nexclude_kk04 ne 0L) then begin
;;;;                   plotsym, kk04_psym, psize, fill=0L, thick=postthick2
;;;;                   if (result[k].r23_branch eq 'U') then begin
;;;;                      if (nexclude_kk04 eq 1L) then $
;;;;                        plots, hiigalaxy[exclude_kk04].rc3_rr25*[1,1], hiigalaxy[exclude_kk04].log12oh_kk04_upper[0]*[1,1], $
;;;;                        ps=8, color=djs_icolor(kk04_color) else $
;;;;                          djs_oplot, hiigalaxy[exclude_kk04].rc3_rr25*[1,1], hiigalaxy[exclude_kk04].log12oh_kk04_upper[0]*[1,1], $
;;;;                        ps=8, color=djs_icolor(kk04_color)
;;;;                   endif else begin
;;;;                      if (nexclude_kk04 eq 1L) then $
;;;;                        plots, hiigalaxy[exclude_kk04].rc3_rr25*[1,1], hiigalaxy[exclude_kk04].log12oh_kk04_lower[0]*[1,1], $
;;;;                        ps=8, color=djs_icolor(kk04_color) else $
;;;;                          djs_oplot, hiigalaxy[exclude_kk04].rc3_rr25*[1,1], hiigalaxy[exclude_kk04].log12oh_kk04_lower[0]*[1,1], $
;;;;                        ps=8, color=djs_icolor(kk04_color)
;;;;                   endelse 
;;;;                endif 
;;;;                if (result[k].hii_kk04_slope[0] ne -999.0) then $
;;;;                  djs_oplot, res_kk04.xaxis, res_kk04.yfit, line=0, thick=postthick2 ;, color=kk04_color
;;;;                plotsym, avg_psym, psize2, fill=0, thick=postthick2
;;;;                if keyword_set(plotavg) then $
;;;;                  oploterror, result[k].hii_kk04_rr25_avg[0], result[k].hii_kk04_log12oh_avg[0], $
;;;;                  result[k].hii_kk04_rr25_avg[1], result[k].hii_kk04_log12oh_avg[1], $
;;;;                  ps=8, color=djs_icolor(avg_color), errcolor=djs_icolor(avg_color), thick=postthick2
;;;;             endif
;;;;; -------------------------                
;;;;; PT05
;;;;; -------------------------                
;;;;             if (npt05_grad ne 0L) and keyword_set(plot_pt05) then begin
;;;;                plotsym, pt05_psym, psize, fill=1L, thick=postthick2
;;;;                if keyword_set(errorbars) then oploterror, rr25_pt05, oh_pt05, rr25_pt05_err, oh_pt05_err, $
;;;;                  ps=8, color=djs_icolor(pt05_color), errcolor=djs_icolor(pt05_color), thick=postthick2 else begin
;;;;                   if (npt05_grad eq 1L) then $
;;;;                     plots, rr25_pt05, oh_pt05, ps=8, color=djs_icolor(pt05_color) else $
;;;;                       djs_oplot, rr25_pt05, oh_pt05, ps=8, color=djs_icolor(pt05_color)
;;;;                endelse 
;;;;                ambig_pt05 = where((hiigalaxy.hii_pt05_r23_flag),nambig_pt05)
;;;;                if (nambig_pt05 ne 0L) then begin
;;;;                   plotsym, pt05_psym, psize, fill=0L, thick=postthick2
;;;;                   for ii = 0L, nambig_pt05-1L do begin
;;;;                      xpt05 = hiigalaxy[ambig_pt05[ii]].rc3_rr25
;;;;                      ypt05_up = hiigalaxy[ambig_pt05[ii]].log12oh_pt05_upper[0]
;;;;                      ypt05_lo = hiigalaxy[ambig_pt05[ii]].log12oh_pt05_lower[0]
;;;;;                     print, xpt05, ypt05_up, ypt05_lo
;;;;                      djs_oplot, xpt05*[1,1], [ypt05_up,ypt05_lo], $
;;;;                        ps=-8, line=0, thick=postthick2, color=djs_icolor(pt05_color)
;;;;                   endfor
;;;;                endif
;;;;                exclude_pt05 = where((hiigalaxy.r23_branch eq 'X'),nexclude_pt05)
;;;;                if (nexclude_pt05 ne 0L) then begin
;;;;                   plotsym, pt05_psym, psize, fill=0L, thick=postthick2
;;;;                   if (result[k].r23_branch eq 'U') then begin
;;;;                      if (nexclude_pt05 eq 1L) then $
;;;;                        plots, hiigalaxy[exclude_pt05].rc3_rr25*[1,1], hiigalaxy[exclude_pt05].log12oh_pt05_upper[0]*[1,1], $
;;;;                        ps=8, color=djs_icolor(pt05_color) else $
;;;;                          djs_oplot, hiigalaxy[exclude_pt05].rc3_rr25*[1,1], hiigalaxy[exclude_pt05].log12oh_pt05_upper[0]*[1,1], $
;;;;                        ps=8, color=djs_icolor(pt05_color)
;;;;                   endif else begin
;;;;                      if (nexclude_pt05 eq 1L) then $
;;;;                        plots, hiigalaxy[exclude_pt05].rc3_rr25*[1,1], hiigalaxy[exclude_pt05].log12oh_pt05_lower[0]*[1,1], $
;;;;                        ps=8, color=djs_icolor(pt05_color) else $
;;;;                          djs_oplot, hiigalaxy[exclude_pt05].rc3_rr25*[1,1], hiigalaxy[exclude_pt05].log12oh_pt05_lower[0]*[1,1], $
;;;;                        ps=8, color=djs_icolor(pt05_color)
;;;;                   endelse 
;;;;                endif 
;;;;                if (result[k].hii_pt05_slope[0] ne -999.0) then $
;;;;                  djs_oplot, res_pt05.xaxis, res_pt05.yfit, line=2, thick=postthick2 ;, color=pt05_color
;;;;                plotsym, avg_psym, psize2, fill=0, thick=postthick2
;;;;                if keyword_set(plotavg) then $
;;;;                  oploterror, result[k].hii_pt05_rr25_avg[0], result[k].hii_pt05_log12oh_avg[0], $
;;;;                  result[k].hii_pt05_rr25_avg[1], result[k].hii_pt05_log12oh_avg[1], $
;;;;                  ps=8, color=djs_icolor(avg_color), errcolor=djs_icolor(avg_color), thick=postthick2
;;;;             endif
;;;;
;;;;; -------------------------                
;;;;; O3N2
;;;;; -------------------------                
;;;;             if (no3n2_grad ne 0L) and keyword_set(plot_o3n2) then begin
;;;;                plotsym, o3n2_psym, psize, fill=1L, thick=postthick2
;;;;                if keyword_set(errorbars) then oploterror, rr25_o3n2, oh_o3n2, rr25_o3n2_err, oh_o3n2_err, $
;;;;                  ps=8, color=djs_icolor(o3n2_color), errcolor=djs_icolor(o3n2_color), thick=postthick2 else begin
;;;;                   if (no3n2_grad eq 1L) then $
;;;;                     plots, rr25_o3n2, oh_o3n2, ps=8, color=djs_icolor(o3n2_color) else $
;;;;                       djs_oplot, rr25_o3n2, oh_o3n2, ps=8, color=djs_icolor(o3n2_color)
;;;;                endelse 
;;;;                exclude_o3n2 = where((hiigalaxy.r23_branch eq 'X'),nexclude_o3n2)
;;;;                if (nexclude_o3n2 ne 0L) then begin
;;;;                   plotsym, o3n2_psym, psize, fill=0L, thick=postthick2
;;;;                   if (nexclude_o3n2 eq 1L) then $
;;;;                     plots, hiigalaxy[exclude_o3n2].rc3_rr25*[1,1], hiigalaxy[exclude_o3n2].log12oh_o3n2[0]*[1,1], $
;;;;                     ps=8, color=djs_icolor(o3n2_color) else $
;;;;                       djs_oplot, hiigalaxy[exclude_o3n2].rc3_rr25*[1,1], hiigalaxy[exclude_o3n2].log12oh_o3n2[0]*[1,1], $
;;;;                     ps=8, color=djs_icolor(o3n2_color)
;;;;                endif  
;;;;                if (result[k].hii_o3n2_slope[0] ne -999.0) then $
;;;;                  djs_oplot, res_o3n2.xaxis, res_o3n2.yfit, line=2, thick=postthick2 ;, color=o3n2_color
;;;;                plotsym, avg_psym, psize2, fill=0, thick=postthick2
;;;;                if keyword_set(plotavg) then $
;;;;                  oploterror, result[k].hii_o3n2_rr25_avg[0], result[k].hii_o3n2_log12oh_avg[0], $
;;;;                  result[k].hii_o3n2_rr25_avg[1], result[k].hii_o3n2_log12oh_avg[1], $
;;;;                  ps=8, color=djs_icolor(avg_color), errcolor=djs_icolor(avg_color), thick=postthick2
;;;;             endif
;;;;
;;;;          endif
;;;;
;;;;; print out some stuff          
;;;;          
;;;;          radsort = sort(hiigalaxy.rc3_rr25)
;;;;
;;;;          if (not keyword_set(silent)) then begin
;;;;             info = replicate({gto_atlas: 0L, galaxy: '', ned_galaxy: '', hii_galaxy: '', region: '', oh_kk04: -999.0, $
;;;;               oh_pt05: -999.0, oh_te: -999.0, branch: '', kk04_flag: 0L, pt05_flag: 0L, rc3_rr25: -999.0, ref: ''},nindx)
;;;;             info.gto_atlas = result[k].gto_atlas
;;;;             info.galaxy = hiigalaxy[radsort].galaxy
;;;;             info.ned_galaxy = hiigalaxy[radsort].ned_galaxy
;;;;             info.hii_galaxy = hiigalaxy[radsort].hii_galaxy
;;;;             info.region = hiigalaxy[radsort].region
;;;;             info.oh_kk04 = hiigalaxy[radsort].log12oh_kk04[0]
;;;;             info.oh_pt05 = hiigalaxy[radsort].log12oh_pt05[0]
;;;;             info.oh_te = hiigalaxy[radsort].log12oh_te[0]
;;;;             info.branch = hiigalaxy[radsort].r23_branch
;;;;             info.kk04_flag = hiigalaxy[radsort].hii_kk04_r23_flag
;;;;             info.pt05_flag = hiigalaxy[radsort].hii_pt05_r23_flag
;;;;             info.rc3_rr25 = hiigalaxy[radsort].rc3_rr25
;;;;             info.ref = hiigalaxy[radsort].reference
;;;;             struct_print, info
;;;;          endif
;;;;
;;;;          if keyword_set(debug) then begin
;;;;             splog, 'Waiting for keystroke.'
;;;;             cc = get_kbrd(1)
;;;;          endif
;;;;
;;;;       endelse                  ; close the HII-region logical statement
;;;;
;;;;    endfor
;;;;
;;;;    if keyword_set(postscript) then begin
;;;;       dfpsclose
;;;;    endif ; else cc = get_kbrd(1)
;;;;
;;;;; ---------------------------------------------------------------------------    
;;;;; construct the final set of metallicities
;;;;; ---------------------------------------------------------------------------    
;;;;
;;;;; ##########    
;;;;; PT05
;;;;; ##########    
;;;;    
;;;;    grad = where((result.log12oh_pt05_char[0] lt 0.0) and (result.hii_pt05_log12oh_char[0] gt -900.0),ngrad)
;;;;    splog, 'Adopting '+string(ngrad,format='(I0)')+' R=0.4*R25 abundances.'
;;;;    result[grad].log12oh_pt05_char = result[grad].hii_pt05_log12oh_char
;;;;    result[grad].log12oh_pt05_char_comment = 'R=0.4*R25'
;;;;    
;;;;    avg = where((result.log12oh_pt05_char[0] lt 0.0) and (result.hii_pt05_log12oh_avg[0] gt -900.0),navg)
;;;;    splog, 'Adopting '+string(navg,format='(I0)')+' average abundances.'
;;;;    result[avg].log12oh_pt05_char = result[avg].hii_pt05_log12oh_avg
;;;;    result[avg].log12oh_pt05_char_comment = 'HII-RegionAverage'
;;;;
;;;;    int = where((result.log12oh_pt05_char[0] lt 0.0) and (result.gto_atlas_log12oh_pt05[0] gt -900.0),nint)
;;;;    splog, 'Adopting '+string(nint,format='(I0)')+' integrated abundances.'
;;;;    result[int].log12oh_pt05_char = result[int].gto_atlas_log12oh_pt05
;;;;    result[int].log12oh_pt05_char_comment = 'Integrated'
;;;;
;;;;; use the HII-region LZ relation for all remaining objects
;;;;
;;;;;   lz = where((result.log12oh_pt05_char[0] lt 0.0) and (result.m_b gt -900.0),nlz)
;;;;;   splog, 'Adopting '+string(nlz,format='(I0)')+' LZ abundances.'
;;;;;   result[lz].log12oh_pt05_char[0] = hiilzfit[1].intercept + hiilzfit[1].slope*result[lz].m_b
;;;;;   result[lz].log12oh_pt05_char[1] = 0.18
;;;;;   result[lz].log12oh_pt05_char_comment = 'LZRelation'
;;;;
;;;;; ##########    
;;;;; KK04
;;;;; ##########    
;;;;    
;;;;    grad = where((result.log12oh_kk04_char[0] lt 0.0) and (result.hii_kk04_log12oh_char[0] gt -900.0),ngrad)
;;;;    splog, 'Adopting '+string(ngrad,format='(I0)')+' R=0.4*R25 abundances.'
;;;;    result[grad].log12oh_kk04_char = result[grad].hii_kk04_log12oh_char
;;;;    result[grad].log12oh_kk04_char_comment = 'R=0.4*R25'
;;;;    
;;;;    avg = where((result.log12oh_kk04_char[0] lt 0.0) and (result.hii_kk04_log12oh_avg[0] gt -900.0),navg)
;;;;    splog, 'Adopting '+string(navg,format='(I0)')+' average abundances.'
;;;;    result[avg].log12oh_kk04_char = result[avg].hii_kk04_log12oh_avg
;;;;    result[avg].log12oh_kk04_char_comment = 'HII-RegionAverage'
;;;;
;;;;    int = where((result.log12oh_kk04_char[0] lt 0.0) and (result.gto_atlas_log12oh_kk04[0] gt -900.0),nint)
;;;;    splog, 'Adopting '+string(nint,format='(I0)')+' integrated abundances.'
;;;;    result[int].log12oh_kk04_char = result[int].gto_atlas_log12oh_kk04
;;;;    result[int].log12oh_kk04_char_comment = 'Integrated'
;;;;
;;;;; use the HII-region LZ relation for all remaining objects
;;;;
;;;;;   lz = where((result.log12oh_kk04_char[0] lt 0.0) and (result.m_b gt -900.0),nlz)
;;;;;   splog, 'Adopting '+string(nlz,format='(I0)')+' LZ abundances.'
;;;;;   result[lz].log12oh_kk04_char[0] = hiilzfit[1].intercept + hiilzfit[1].slope*result[lz].m_b
;;;;;   result[lz].log12oh_kk04_char[1] = 0.18
;;;;;   result[lz].log12oh_kk04_char_comment = 'LZRelation'
;;;;
;;;;; write out    
;;;;    
;;;;    if keyword_set(postscript) then begin
;;;;       outfile = 'gto_log12oh_'+version+'.fits'
;;;;       splog, 'Writing '+outpath+outfile+'.'
;;;;       mwrfits, result, outpath+outfile, /create
;;;;       spawn, ['gzip -f '+outpath+outfile], /sh
;;;;    endif
;;;;
;;;;    final_result = im_struct_trimtags(result,select=['GALAXY','M_B','R23_BRANCH','HII_TE_LOG12OH_AVG',$
;;;;      'LOG12OH_PT05_CHAR','LOG12OH_KK04_CHAR','LOG12OH_KK04_CHAR_COMMENT','DISTANCE','DISTANCE_ERR',$
;;;;      'DISTANCE_REF'],newtags=['GALAXY','M_B','BRANCH','LOG12OH_TE','PT05_LOG12OH_CHAR','KK04_LOG12OH_CHAR',$
;;;;      'CHAR_COMMENT','DISTANCE','DISTANCE_ERR','DISTANCE_REF'])
;;;;;   struct_print, final_result
;;;;
;;;;    if keyword_set(postscript) then begin
;;;;       outfile = 'gto_log12oh_final_'+version+'.fits'
;;;;       splog, 'Writing '+outpath+outfile+'.'
;;;;       mwrfits, result, outpath+outfile, /create
;;;;       spawn, ['gzip -f '+outpath+outfile], /sh
;;;;
;;;;       txtoutfile = repstr(outfile,'.fits','.dat')
;;;;       splog, 'Writing '+outpath+txtoutfile+'.'
;;;;       openw, lun, outpath+txtoutfile, /get_lun
;;;;       printf, lun, '## Nebular Abundances: GTO/Starbursts'
;;;;       printf, lun, '## John Moustakas, john.moustakas@gmail.com, '+im_today()
;;;;       printf, lun, '## PROVISIONAL'
;;;;       printf, lun, '## '+version
;;;;       printf, lun, '## Discarded or "no measurement" are indicated using -999.'
;;;;       printf, lun, '#  1 Galaxy'
;;;;       printf, lun, '#  2 M_B [mag]'
;;;;       printf, lun, '#  3 Branch [U=upper, L=lower]'
;;;;       printf, lun, '#  4 Log12oh_Te [Average Electron temperature abundance]'
;;;;       printf, lun, '#  5 Log12oh_Te_Err'
;;;;       printf, lun, '#  6 Log12oh_PT05_Char ["Characteristic" Abundance]'
;;;;       printf, lun, '#  7 Log12oh_PT05_Char_Err'
;;;;       printf, lun, '#  8 Log12oh_KK04_Char ["Characteristic" Abundance]'
;;;;       printf, lun, '#  9 Log12oh_KK04_Char_Err'
;;;;       printf, lun, '# 10 Log12oh_Comment'
;;;;       printf, lun, '# 11 Distance'
;;;;       printf, lun, '# 12 Distance_Err'
;;;;       printf, lun, '# 13 Distance_Ref'
;;;;       struct_print, final_result, lun=lun, /no_head
;;;;       free_lun, lun
;;;;    endif
;;;;
;;;;;   plotsym, 0, 1.4, /fill
;;;;;   g = where(final_result.pt05_log12oh_char[0] gt -900 and final_result.m_b gt -900,ng)
;;;;;   plot, final_result[g].m_b, final_result[g].pt05_log12oh_char[0], ps=8, xsty=3, ysty=3, $
;;;;;     xrange=[-12,-23], yrange=[7.3,9.4], charsize=1.8, charthick=2.0, xthick=2.0, ythick=2.0, $
;;;;;     xtitle='M_{B}', ytitle='12 + log (O/H) [PT05]'
;;;;    
;;;;    plotsym, 0, 1.4, fill=1
;;;;    g = where(final_result.kk04_log12oh_char[0] gt -900 and final_result.m_b gt -900,ng)
;;;;    plot, final_result[g].m_b, final_result[g].kk04_log12oh_char[0], ps=8, xsty=3, ysty=3, $
;;;;      xrange=[-11.5,-24], yrange=[7.0,9.4], charsize=1.8, charthick=2.0, xthick=2.0, ythick=2.0, $
;;;;      xtitle='M_{B}', ytitle='12 + log (O/H) [KK04]'
;;;;    plotsym, 0, 1.4, fill=0
;;;;    g2 = where(final_result.log12oh_te[0] gt -900 and final_result.kk04_log12oh_char[0] gt -900 and final_result.m_b gt -900)
;;;;    oplot, final_result[g2].m_b, final_result[g2].log12oh_te[0], ps=8
;;;;    struct_print, final_result[g2]
;;;;    
;;;;    for ii = 0L, ng-1L do begin
;;;;       gal = strtrim(final_result[g[ii]].galaxy,2)
;;;;       x = final_result[g[ii]].m_b
;;;;       y = final_result[g[ii]].kk04_log12oh_char[0]
;;;;       align = 0.0 & xoff = +0.05 & yoff = 0.0
;;;;;      if strmatch(gal,'*ngc1614*',/fold) then begin
;;;;;         align = 0.0 & xoff = +0.05 & yoff = -0.02
;;;;;      endif
;;;;;      if strmatch(gal,'*ngc2146*',/fold) then begin
;;;;;         align = 0.0 & xoff = +0.05 & yoff = +0.02
;;;;;      endif
;;;;       xyouts, x+xoff, y+yoff, gal, /data, charsize=1.0, charthick=1.3, align=align
;;;;    endfor
;;;;    
;;;;stop
;;;;    
;;;;    plotsym, 0, 1.4, /fill
;;;;    g = where(final_result.pt05_log12oh_int[0] gt -900 and final_result.log12oh_te[0] gt -900)
;;;;    plot, final_result[g].pt05_log12oh_int[0], final_result[g].log12oh_te[0], ps=8, xsty=3, ysty=3, $
;;;;      xrange=[7.3,9.2], yrange=[7.3,9.2], charsize=1.8, charthick=2.0, xthick=2.0, ythick=2.0, $
;;;;      xtitle='12 + log (O/H) [PT05 Integrated]', ytitle='12 + log (O/H) [Te]'
;;;;    oplot, !x.crange, !y.crange
;;;;    
;;;;    g = where(final_result.kk04_log12oh_int[0] gt -900 and final_result.log12oh_te[0] gt -900)
;;;;    plot, final_result[g].kk04_log12oh_int[0], final_result[g].log12oh_te[0], ps=8, xsty=3, ysty=3, $
;;;;      xrange=[7.3,9.2], yrange=[7.3,9.2], charsize=1.8, charthick=2.0, xthick=2.0, ythick=2.0, $
;;;;      xtitle='12 + log (O/H) [KK04 Integrated]', ytitle='12 + log (O/H) [Te]'
;;;;    oplot, !x.crange, !y.crange
;;;;    
;;;;
;;;;stop
;;;;    
;;;;return
;;;;end 
;;;;
;;;;;   final_result = im_struct_trimtags(result,select=['GALAXY','M_B','R23_BRANCH',$
;;;;;     'LOG12OH_KK04_CHAR','GTO_ATLAS_LOG12OH_KK04','LOG12OH_PT05_CHAR',$
;;;;;     'GTO_ATLAS_LOG12OH_PT05','HII_TE_LOG12OH_AVG'],newtags=['GALAXY','M_B',$
;;;;;     'BRANCH','KK04_LOG12OH_HII','KK04_LOG12OH_INT','PT05_LOG12OH_HII','PT05_LOG12OH_INT',$
;;;;;     'LOG12OH_TE'])
;;;;;   struct_print, final_result
;;;;;
;;;;;   if keyword_set(postscript) then begin
;;;;;      outfile = 'gto_log12oh_final_'+version+'.fits'
;;;;;      splog, 'Writing '+outpath+outfile+'.'
;;;;;      mwrfits, result, outpath+outfile, /create
;;;;;      spawn, ['gzip -f '+outpath+outfile], /sh
;;;;;
;;;;;      txtoutfile = repstr(outfile,'.fits','.dat')
;;;;;      splog, 'Writing '+outpath+txtoutfile+'.'
;;;;;      openw, lun, outpath+txtoutfile, /get_lun
;;;;;      printf, lun, '## Nebular Abundances: GTO/Starbursts'
;;;;;      printf, lun, '## John Moustakas, john.moustakas@gmail.com, '+im_today()
;;;;;      printf, lun, '## PROVISIONAL'
;;;;;      printf, lun, '## '+version
;;;;;      printf, lun, '## Discarded or "no measurement" are indicated using -999.'
;;;;;      printf, lun, '#  1 Galaxy'
;;;;;      printf, lun, '#  2 M_B [mag]'
;;;;;      printf, lun, '#  3 Branch [U=upper, L=lower]'
;;;;;      printf, lun, '#  4 Log12oh_KK04_HII [Abundance at R=0.4*R25]'
;;;;;      printf, lun, '#  5 Log12oh_KK04_HII_Err'
;;;;;      printf, lun, '#  6 Log12oh_KK04_Int [Integrated Abundance]'
;;;;;      printf, lun, '#  7 Log12oh_KK04_Int_Err'
;;;;;      printf, lun, '#  8 Log12oh_PT05_HII [Abundance at R=0.4*R25]'
;;;;;      printf, lun, '#  9 Log12oh_PT05_HII_Err'
;;;;;      printf, lun, '# 10 Log12oh_PT05_Int [Integrated Abundance]'
;;;;;      printf, lun, '# 11 Log12oh_PT05_Int_Err'
;;;;;      printf, lun, '# 12 Log12oh_Te [Electron temperature abundance]'
;;;;;      printf, lun, '# 13 Log12oh_Te_Err'
;;;;;      struct_print, final_result, lun=lun, /no_head
;;;;;      free_lun, lun
;;;;;   endif
;;;;
